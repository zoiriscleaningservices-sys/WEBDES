<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueWebX â€“ Command Center</title>
    <link rel="canonical" href="https://truewebx.site/dashboard.html">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        /* 
         * TRUEWEBX EXTREME DASHBOARD - COMMAND CENTER
         * Design System: Cyber-Executive
         */
        :root {
            /* Neo-Glass Palette */
            --bg-deep: #030014;
            --bg-liquid: radial-gradient(circle at 50% 50%, #4f46e5 0%, #0f172a 40%, #000000 100%);
            --glass-panel: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --neon-primary: #00f3ff;
            --neon-secondary: #bd00ff;
            --neon-success: #00ff9d;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);

            /* Spatial Depth */
            --shadow-nav: 0 20px 50px rgba(0, 0, 0, 0.5);
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.3);

            /* Animations */
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Animations */
        @keyframes slideInRight {
            from {
                transform: translateX(50px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-50px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in-left {
            animation: slideInLeft 0.4s var(--ease-elastic) forwards;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 243, 255, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 243, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 243, 255, 0);
            }
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: var(--neon-primary);
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--neon-primary);
        }

        /* Spatial Inbox */
        .inbox-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .inbox-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--neon-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .inbox-card:hover {
            background: rgba(255, 255, 255, 0.07);
            transform: translateX(5px);
            border-color: var(--neon-primary);
        }

        .inbox-card.active {
            background: rgba(0, 243, 255, 0.08);
            border-color: var(--neon-primary);
        }

        .inbox-card.active::before {
            opacity: 1;
        }

        .inbox-avatar {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(0, 243, 255, 0.1), rgba(189, 0, 255, 0.1));
            border: 1px solid var(--glass-border);
            display: grid;
            place-items: center;
            font-weight: 700;
            color: var(--neon-primary);
            flex-shrink: 0;
        }

        .inbox-info {
            flex: 1;
            min-width: 0;
        }

        .inbox-name {
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
        }

        .inbox-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        /* Chat Bubbles */
        .chat-bubble-owner {
            align-self: flex-end;
            background: rgba(0, 243, 255, 0.2);
            border: 1px solid var(--neon-primary);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 20px;
            padding: 12px 18px;
            max-width: 75%;
            color: #fff;
            margin-bottom: 10px;
        }

        .chat-bubble-guest {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 20px 0;
            padding: 12px 18px;
            max-width: 75%;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Ambient Liquid Background */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-liquid);
            filter: blur(80px);
            z-index: -1;
            animation: pulse-bg 20s ease-in-out infinite alternate;
        }

        @keyframes pulse-bg {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.2);
                opacity: 0.5;
            }
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .nav-dock {
            /* Desktop Default */
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: auto;
            border-radius: 40px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 40px 0;
            z-index: 1000;
            transition: all 0.4s var(--ease-elastic);
        }

        /* Mobile "Command Capsule" Override */
        @media (max-width: 768px) {
            .nav-dock {
                top: auto;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                height: 70px;
                flex-direction: row;
                justify-content: space-evenly;
                align-items: center;
                padding: 0;
                border-radius: 35px;
                background: rgba(10, 10, 20, 0.6);
                /* Darker for contrast */
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* LAYOUT */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.6s ease, transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .app-container.loaded {
            opacity: 1;
            transform: scale(1);
        }

        /* CONTENT AREA (New Layout) */
        .content-area {
            flex: 1;
            margin-left: 120px;
            /* Desktop Dock Offset */
            padding: 40px;
            overflow-y: auto;
            position: relative;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .content-area {
                margin-left: 0;
                padding: 20px;
                padding-bottom: 120px;
                /* Space for Capsule */
            }
        }

        /* Typography Helper */
        .font-tech {
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* WIDGETS & CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-panel);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--glass-highlight);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Rajdhani', sans-serif;
            display: block;
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
        }

        .service-panel {
            background: rgba(20, 20, 30, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .service-panel:hover {
            background: rgba(30, 30, 45, 0.6);
            border-color: var(--primary-glow);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.15);
            transform: scale(1.02);
        }

        .service-header {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .service-thumb {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--glass-border);
        }

        .service-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            opacity: 0.6;
            transition: 0.3s;
        }

        .service-panel:hover .service-actions {
            opacity: 1;
        }

        .action-chip {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            transition: 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-chip:hover {
            background: #fff;
            color: #000;
        }

        /* WIZARD & FORMS */
        .wizard-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
            z-index: 0;
        }

        .step-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-deep);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: grid;
            place-items: center;
            position: relative;
            z-index: 1;
            font-weight: 700;
            color: var(--text-muted);
            transition: 0.3s;
        }

        .step-dot.active {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.1);
        }

        .step-content {
            background: var(--bg-panel);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            position: relative;
            backdrop-filter: blur(20px);
            animation: slideInUp 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .cyber-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            border-radius: 12px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            transition: 0.3s;
        }

        .cyber-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background: rgba(0, 0, 0, 0.5);
        }

        .btn-cyber {
            padding: 14px 30px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .hidden-section {
            display: none;
        }

        /* Login styles preserved minimally */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
        }

        /* Mobile */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 15px;
                align-items: center;
                justify-content: space-between;
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
            }

            .nav-link span {
                display: none;
            }

            .user-profile-mini span {
                display: none;
            }

            .main-area {
                height: calc(100vh - 70px);
            }

            .top-bar {
                padding: 0 20px;
                height: 60px;
            }
        }

        /* SEO Widget Override */
        .seo-widget {
            background: rgba(255, 255, 255, 0.02);
            border: none;
            box-shadow: none;
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .seo-score-container {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }

        .circular-chart {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            max-height: 250px;
        }

        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 3.8;
        }

        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease-out;
        }

        .percentage {
            fill: #fff;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 0.5em;
            text-anchor: middle;
        }

        .audit-list {
            flex: 1;
            display: grid;
            gap: 8px;
        }

        .audit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .status-pass {
            color: var(--success);
        }

        .status-fail {
            color: var(--accent);
        }

        .status-warn {
            color: #facc15;
        }

        .seo-feedback {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
            width: 100%;
            text-align: center;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
            backdrop-filter: blur(10px);
            /* Slight blur on background for focus */
        }
    </style>
</head>

<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="form"
            style="width:100%; max-width:450px; background: rgba(30, 30, 40, 0.8); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); color: white; padding:40px; border-radius:24px; text-align:center;">
            <h2 style="margin-bottom:30px; font-family:'Rajdhani', sans-serif; font-size:2.5rem; letter-spacing:2px;"
                id="formTitle">IDENTIFY</h2>
            <form id="authForm">
                <div class="form-group">
                    <input id="email" placeholder="Access Code (Email)" class="cyber-input" type="email" required>
                </div>
                <div class="form-group">
                    <input id="password" placeholder="Encryption Key (Password)" class="cyber-input" type="password"
                        required>
                </div>
                <button type="submit" class="btn-cyber btn-primary" id="authButton"
                    style="width:100%; justify-content:center;">INITIALIZE SESSION</button>
            </form>
            <div id="message"></div>
            <p style="margin-top:20px; opacity:0.6; cursor:pointer;" onclick="toggleAuthMode()">
                <span id="toggleText">Need clearance?</span> <span
                    style="color:var(--primary); font-weight:bold;">Request Access</span>
            </p>
            <div style="margin-top:20px;">
                <button type="button" class="btn google" id="googleBtn"
                    style="width:100%; background:white; color:black; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <i class="fab fa-google"></i> Google Identity
                </button>
            </div>
        </div>
    </div>

    <!-- Ambient Background -->
    <div class="liquid-bg"></div>

    <div id="appContainer" class="app-container">
        <!-- Navigation Dock (Desktop Left / Mobile Bottom) -->
        <nav class="nav-dock glass-panel">
            <div class="nav-item active" onclick="show('home')" title="Mission Control">
                <i class="fas fa-globe"></i>
            </div>
            <div class="nav-item" onclick="show('add')" title="Launch Sequence">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="nav-item" onclick="show('messages')" title="Comms Link">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div class="nav-item" onclick="logoutAndGoHome()" title="Abort Session"
                style="margin-top:auto; color:#f43f5e;">
                <i class="fas fa-power-off"></i>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="content-area" id="mainScroll">

            <!-- Header / Status Bar -->
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                <div>
                    <h1 class="font-tech" id="pageTitle"
                        style="font-size:2.5rem; background:linear-gradient(to right, #fff, var(--text-muted)); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                        MISSION CONTROL</h1>
                    <div style="font-size:0.9rem; color:var(--text-muted); display:flex; gap:10px; align-items:center;">
                        <span id="userName">OPERATOR</span>
                        <span
                            style="width:6px; height:6px; background:var(--neon-success); border-radius:50%; box-shadow:0 0 10px var(--neon-success);"></span>
                        SYSTEM ONLINE
                    </div>
                </div>
                <!-- Profile Avatar -->
                <div id="userAvatar"
                    style="width:50px; height:50px; border-radius:16px; background:var(--glass-highlight); border:1px solid var(--glass-border); cursor:pointer;">
                </div>
            </header>

            <!-- DASHBOARD SCREEN -->
            <div id="dashboardScreen" style="display:flex; flex-direction:column; width:100%;">

                <!-- PLACEHOLDERS FOR VIEWS -->
                <!-- HOME VIEW -->
                <div id="home">
                    <!-- Stats Section -->
                    <div class="stats-grid">
                        <div class="data-crystal">
                            <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">ACTIVE
                                DEPLOYMENTS</div>
                            <div id="activeDeployments"
                                style="font-size:2.5rem; font-weight:700; color:var(--neon-primary);">--</div>
                            <div style="font-size:0.8rem; color:var(--neon-success); margin-top:5px;"><i
                                    class="fas fa-arrow-up"></i> All Systems Nominal</div>
                        </div>
                        <div class="data-crystal">
                            <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">TOTAL
                                INTERACTIONS</div>
                            <div id="totalInteractions"
                                style="font-size:2.5rem; font-weight:700; color:var(--neon-secondary);">--</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">+12% from last cycle
                            </div>
                        </div>
                        <div class="data-crystal">
                            <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">SYSTEM STATUS
                            </div>
                            <div
                                style="font-size:2.5rem; font-weight:700; color:#fff; display:flex; align-items:center; gap:10px;">
                                SYNCED <div class="pulse-dot"></div>
                            </div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Frequency: 432Hz
                            </div>
                        </div>
                    </div>

                    <h2 class="font-tech"
                        style="font-size:1.5rem; margin-bottom:20px; display:flex; align-items:center; gap:15px;">
                        <i class="fas fa-network-wired" style="color:var(--neon-primary);"></i> LIVE OPERATIONS
                    </h2>
                    <div class="services-grid" id="list"></div>
                </div>

                <!-- ADD WIZARD VIEW -->
                <div id="add" class="hidden-section">
                    <div class="wizard-container">
                        <h2
                            style="font-family:'Rajdhani', sans-serif; font-size:2rem; margin-bottom:40px; text-align:center;">
                            Launch New Service Sequence</h2>

                        <!-- Wizard Headers -->
                        <div class="wizard-steps">
                            <div class="step-dot active" data-step="1">1</div>
                            <div class="step-dot" data-step="2">2</div>
                            <div class="step-dot" data-step="3">3</div>
                        </div>

                        <form id="addForm">
                            <!-- STEP 1: Core Details -->
                            <div class="step-content" id="step1">
                                <h3 style="margin-bottom:20px; color:var(--primary);">Target Identification</h3>
                                <div class="form-group">
                                    <label class="form-label">Operation Name (Business Name)</label>
                                    <input type="text" id="name" class="cyber-input" placeholder="e.g. Apex Cleaners"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sector Coordinates (City)</label>
                                    <div style="position:relative;">
                                        <input type="text" id="cityAddInput" class="cyber-input"
                                            placeholder="Search Sector..." autocomplete="off" required>
                                        <div id="cityAddList"
                                            style="position:absolute; top:100%; left:0; right:0; background:var(--bg-panel); border:1px solid var(--glass-border); border-radius:12px; max-height:200px; overflow-y:auto; z-index:50; display:none;">
                                        </div>
                                        <input type="hidden" id="cityAdd" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Zone Code (ZIP - Optional)</label>
                                    <input type="text" id="zipAdd" class="cyber-input" placeholder="5-Digit Code"
                                        maxlength="5">
                                </div>
                                <div style="text-align:right;">
                                    <button type="button" class="btn-cyber btn-primary" onclick="nextStep(2)">Proceed to
                                        Step 2 <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>

                            <!-- STEP 2: Comms & Intel -->
                            <div class="step-content hidden-section" id="step2">
                                <h3 style="margin-bottom:20px; color:var(--primary);">Comms & Intelligence</h3>
                                <div class="form-group">
                                    <label class="form-label">Secure Line (Phone)</label>
                                    <input type="tel" id="phone" class="cyber-input" placeholder="(555) 000-0000"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Digital Uplink (Email)</label>
                                    <input type="email" id="gmail" class="cyber-input" placeholder="contact@domain.com"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mission Brief (Description)</label>
                                    <textarea id="desc" class="cyber-input" rows="5"
                                        placeholder="Describe critical mission details..." required></textarea>
                                </div>

                                <!-- SEO Audit Widget -->
                                <div class="seo-widget" id="seoWidgetAdd">
                                    <div class="seo-score-container">
                                        <svg viewBox="0 0 36 36" class="circular-chart">
                                            <path class="circle-bg"
                                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                            <path class="circle" stroke-dasharray="0, 100"
                                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                style="stroke: #4ade80;" />
                                            <text x="18" y="20.35" class="percentage">0%</text>
                                        </svg>
                                    </div>
                                    <div class="audit-list">
                                        <div
                                            style="margin-bottom:5px; font-weight:800; font-size:1rem; letter-spacing:1px; color:#fff;">
                                            RANKING PROBABILITIES</div>
                                        <div class="audit-item"><span style="opacity:0.7;">Title Efficiency</span> <span
                                                class="audit-status status-fail" data-check="title">Scanning...</span>
                                        </div>
                                        <div class="audit-item"><span style="opacity:0.7;">Content Depth</span> <span
                                                class="audit-status status-fail" data-check="desc">Scanning...</span>
                                        </div>
                                        <div class="audit-item"><span style="opacity:0.7;">Keyword Density</span> <span
                                                class="audit-status status-fail"
                                                data-check="keywords">Scanning...</span></div>
                                        <div class="audit-item"><span style="opacity:0.7;">Visual Assets</span> <span
                                                class="audit-status status-fail" data-check="media">Scanning...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="seo-feedback" id="seoFeedbackAdd">Awaiting Intelligence Input...</div>

                                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                                    <button type="button" class="btn-cyber btn-secondary" onclick="prevStep(1)"><i
                                            class="fas fa-arrow-left"></i> Back</button>
                                    <button type="button" class="btn-cyber btn-primary" onclick="nextStep(3)">Proceed to
                                        Step 3 <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>

                            <!-- STEP 3: Visuals & Launch -->
                            <div class="step-content hidden-section" id="step3">
                                <h3 style="margin-bottom:20px; color:var(--primary);">Visual Assets & Launch</h3>

                                <div class="form-group">
                                    <label class="form-label">Identity Marker (Profile Logo)</label>
                                    <input type="file" id="profile" accept="image/*" class="cyber-input" required>
                                    <div id="profilePreview"
                                        style="margin-top:10px; display:flex; justify-content:center;"></div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Field Imagery (Gallery)</label>
                                    <input type="file" id="photos" accept="image/*" multiple class="cyber-input">
                                    <div id="galleryPreview"
                                        style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;"></div>
                                </div>

                                <div class="form-group" id="social-container">
                                    <label class="form-label">External Uplinks (Social Media)</label>
                                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                                        <select id="social-type" class="cyber-input" style="width:140px;">
                                            <option value="instagram">Instagram</option>
                                            <option value="tiktok">TikTok</option>
                                            <option value="facebook">Facebook</option>
                                            <option value="twitter">X (Twitter)</option>
                                            <option value="linkedin">LinkedIn</option>
                                            <option value="youtube">YouTube</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="other">Other</option>
                                        </select>
                                        <input type="url" id="social-url" class="cyber-input" placeholder="https://...">
                                        <button type="button" class="btn-cyber btn-secondary"
                                            onclick="addSocialLink()">+</button>
                                    </div>
                                    <div id="added-socials" style="display:flex; flex-direction:column; gap:8px;"></div>
                                </div>

                                <div style="display:flex; justify-content:space-between; margin-top:30px;">
                                    <button type="button" class="btn-cyber btn-secondary" onclick="prevStep(2)"><i
                                            class="fas fa-arrow-left"></i> Back</button>
                                    <button type="button" id="publishBtn" class="btn-cyber btn-primary"
                                        style="background:var(--success); box-shadow:0 0 20px var(--success-glow);">INITIATE
                                        LAUNCH SEQUENCE</button>
                                </div>
                                <p id="msg" style="text-align:center; margin-top:10px;"></p>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="edit" class="hidden-section">
                    <div class="wizard-container">
                        <h2 class="font-tech" style="font-size:2rem; margin-bottom:40px; text-align:center;">Modify
                            Service Protocols</h2>

                        <!-- Wizard Headers -->
                        <div class="wizard-steps">
                            <div class="step-dot edit-dot active" data-step="1">1</div>
                            <div class="step-dot edit-dot" data-step="2">2</div>
                            <div class="step-dot edit-dot" data-step="3">3</div>
                        </div>

                        <form id="editForm">
                            <!-- STEP 1: Core Identification -->
                            <div class="step-content" id="editStep1">
                                <h3 style="margin-bottom:20px; color:var(--neon-primary);">Sector Identification</h3>
                                <div class="form-group">
                                    <label class="form-label">Operation Name</label>
                                    <input type="text" id="edit-name" class="cyber-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sector Coordinates</label>
                                    <div style="position:relative;">
                                        <input type="text" id="cityEditInput" class="cyber-input"
                                            placeholder="Search Sector..." autocomplete="off">
                                        <div id="cityEditList"
                                            style="position:absolute; top:100%; left:0; right:0; background:var(--bg-panel); border:1px solid var(--glass-border); border-radius:12px; max-height:200px; overflow-y:auto; z-index:50; display:none;">
                                        </div>
                                        <input type="hidden" id="cityEdit">
                                    </div>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                    <div class="form-group">
                                        <label class="form-label">Zone Code</label>
                                        <input type="text" id="zipEdit" class="cyber-input" maxlength="5">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Secure Line</label>
                                        <input type="tel" id="edit-phone" class="cyber-input" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Digital Uplink (Gmail)</label>
                                    <input type="email" id="edit-gmail" class="cyber-input" required>
                                </div>
                                <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                                    <button type="button" class="btn-cyber btn-primary"
                                        onclick="nextEditStep(2)">Proceed to Step 2 <i
                                            class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>

                            <!-- STEP 2: Mission Brief & SEO -->
                            <div class="step-content hidden-section" id="editStep2">
                                <h3 style="margin-bottom:20px; color:var(--neon-primary);">Intelligence & Analysis</h3>
                                <div class="form-group">
                                    <label class="form-label">Mission Brief (Description)</label>
                                    <textarea id="edit-desc" class="cyber-input" rows="5" required></textarea>
                                </div>

                                <!-- SEO Audit Widget -->
                                <div class="seo-widget" id="seoWidgetEdit">
                                    <div class="seo-score-container">
                                        <svg viewBox="0 0 36 36" class="circular-chart">
                                            <path class="circle-bg"
                                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                            <path class="circle" stroke-dasharray="0, 100"
                                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                style="stroke: #4ade80;" />
                                            <text x="18" y="20.35" class="percentage">0%</text>
                                        </svg>
                                    </div>
                                    <div class="audit-list">
                                        <div
                                            style="margin-bottom:5px; font-weight:800; font-size:1rem; letter-spacing:1px; color:#fff;">
                                            RANKING PROBABILITIES</div>
                                        <div class="audit-item"><span style="opacity:0.7;">Title Efficiency</span> <span
                                                class="audit-status status-fail" data-check="title">Scanning...</span>
                                        </div>
                                        <div class="audit-item"><span style="opacity:0.7;">Content Depth</span> <span
                                                class="audit-status status-fail" data-check="desc">Scanning...</span>
                                        </div>
                                        <div class="audit-item"><span style="opacity:0.7;">Keyword Density</span> <span
                                                class="audit-status status-fail"
                                                data-check="keywords">Scanning...</span></div>
                                    </div>
                                </div>
                                <div class="seo-feedback" id="seoFeedbackEdit">Updating Analysis...</div>

                                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                                    <button type="button" class="btn-cyber btn-secondary" onclick="prevEditStep(1)"><i
                                            class="fas fa-arrow-left"></i> Back</button>
                                    <button type="button" class="btn-cyber btn-primary"
                                        onclick="nextEditStep(3)">Proceed to Step 3 <i
                                            class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>

                            <!-- STEP 3: Visuals & Save -->
                            <div class="step-content hidden-section" id="editStep3">
                                <h3 style="margin-bottom:20px; color:var(--neon-primary);">Visuals & Uplinks</h3>
                                <div class="form-group">
                                    <label class="form-label">Update Identity Marker</label>
                                    <input type="file" id="edit-profile" accept="image/*" class="cyber-input">
                                    <div id="editProfilePreview"
                                        style="margin-top:10px; display:flex; justify-content:center;"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Append Field Imagery</label>
                                    <input type="file" id="edit-photos" accept="image/*" multiple class="cyber-input">
                                    <div id="editGalleryPreview"
                                        style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">External Uplinks</label>
                                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                                        <select id="edit-social-type" class="cyber-input" style="width:140px;">
                                            <option value="instagram">Instagram</option>
                                            <option value="tiktok">TikTok</option>
                                            <option value="facebook">Facebook</option>
                                            <option value="twitter">X (Twitter)</option>
                                            <option value="linkedin">LinkedIn</option>
                                            <option value="youtube">YouTube</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="other">Other</option>
                                        </select>
                                        <input type="url" id="edit-social-url" class="cyber-input"
                                            placeholder="https://...">
                                        <button type="button" class="btn-cyber btn-secondary"
                                            onclick="addSocialLink(true)">+</button>
                                    </div>
                                    <div id="edit-added-socials" style="display:flex; flex-direction:column; gap:8px;">
                                    </div>
                                </div>

                                <div style="display:flex; justify-content:space-between; margin-top:30px;">
                                    <button type="button" class="btn-cyber btn-secondary" onclick="prevEditStep(2)"><i
                                            class="fas fa-arrow-left"></i> Back</button>
                                    <button type="button" onclick="updateService()" class="btn-cyber btn-primary"
                                        style="background:var(--neon-secondary);">SAVE CONFIGURATION</button>
                                </div>
                                <p id="edit-msg" style="text-align:center; margin-top:10px;"></p>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- MESSAGES VIEW -->
                <div id="messages" class="hidden-section"
                    style="height:calc(100vh - 180px); display:none; flex-direction:row; gap:20px; overflow:hidden;">

                    <!-- Inbox List -->
                    <div style="width:320px; display:flex; flex-direction:column; gap:15px;">
                        <h3 class="font-tech" style="font-size:1rem; color:var(--text-muted);">Incoming Transmissions
                        </h3>
                        <div id="inboxList" class="glass-panel"
                            style="flex:1; overflow-y:auto; border-radius:24px; padding:10px;"></div>
                    </div>

                    <!-- Chat Area -->
                    <div class="glass-panel"
                        style="flex:1; display:flex; flex-direction:column; border-radius:32px; overflow:hidden; position:relative;">
                        <div id="chatHeader" class="font-tech"
                            style="padding:25px; border-bottom:1px solid var(--glass-border); font-size:1rem; background:rgba(255,255,255,0.02);">
                            Select a frequency...
                        </div>

                        <div id="chatBody"
                            style="flex:1; overflow-y:auto; padding:25px; display:flex; flex-direction:column; gap:15px;">
                            <!-- Messages will appear here -->
                            <div style="margin:auto; text-align:center; opacity:0.3;">
                                <i class="fas fa-satellite-dish" style="font-size:4rem; margin-bottom:20px;"></i>
                                <p>Waiting for Secure Uplink</p>
                            </div>
                        </div>

                        <!-- Chat Controls -->
                        <div id="chatInputArea"
                            style="padding:20px 30px; background:rgba(255,255,255,0.03); border-top:1px solid var(--glass-border); display:none; align-items:center; gap:15px; position:relative;">
                            <button type="button" onclick="toggleEmojiPicker()"
                                style="background:none; border:none; color:var(--neon-primary); font-size:1.5rem; cursor:pointer; opacity:0.7;">
                                <i class="far fa-smile"></i>
                            </button>
                            <input type="text" id="chatMsg" class="cyber-input" placeholder="Transmit message..."
                                style="border-radius:25px; padding:12px 25px;">
                            <button onclick="sendChatMessage()" id="chatSendBtn" class="btn-cyber btn-primary"
                                style="border-radius:50%; width:50px; height:50px; padding:0; display:grid; place-items:center; background:linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));">
                                <i class="fas fa-location-arrow" style="transform:translate(2px, -2px);"></i>
                            </button>

                            <!-- Emoji Picker -->
                            <div id="emojiPicker"
                                style="display:none; position:absolute; bottom:80px; left:20px; background:rgba(10,10,20,0.95); border:1px solid var(--glass-border); border-radius:20px; padding:15px; grid-template-columns:repeat(6, 1fr); gap:10px; z-index:100; backdrop-filter:blur(20px);">
                                <span onclick="addEmoji('\uD83D\uDE0A')"
                                    style="cursor:pointer; font-size:24px;">ðŸ˜Š</span>
                                <span onclick="addEmoji('\uD83D\uDE02')"
                                    style="cursor:pointer; font-size:24px;">ðŸ˜‚</span>
                                <span onclick="addEmoji('\u2764\uFE0F')"
                                    style="cursor:pointer; font-size:24px;">â¤ï¸</span>
                                <span onclick="addEmoji('\uD83D\uDC4D')"
                                    style="cursor:pointer; font-size:24px;">ðŸ‘</span>
                                <span onclick="addEmoji('\uD83D\uDD25')"
                                    style="cursor:pointer; font-size:24px;">ðŸ”¥</span>
                                <span onclick="addEmoji('\uD83D\uDE4C')"
                                    style="cursor:pointer; font-size:24px;">ðŸ™Œ</span>
                            </div>
                        </div>

                        <!-- Reaction Bar & Delete Menu -->
                        <div id="reactionBar"
                            style="display:none; position:absolute; background:rgba(20,20,30,0.9); padding:10px 20px; border-radius:30px; gap:15px; z-index:200; border:1px solid var(--glass-border); backdrop-filter:blur(10px);">
                            <span onclick="reactToMessage('\u2764\uFE0F')"
                                style="cursor:pointer; font-size:20px;">â¤ï¸</span>
                            <span onclick="reactToMessage('\uD83D\uDE02')"
                                style="cursor:pointer; font-size:20px;">ðŸ˜‚</span>
                            <span onclick="reactToMessage('\uD83D\uDC4D')"
                                style="cursor:pointer; font-size:20px;">ðŸ‘</span>
                            <span onclick="reactToMessage('\uD83D\uDD25')"
                                style="cursor:pointer; font-size:20px;">ðŸ”¥</span>
                        </div>

                        <div id="deleteMenu"
                            style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.95); padding:30px; border:1px solid var(--glass-border); z-index:300; border-radius:30px; text-align:center; backdrop-filter:blur(20px);">
                            <h3 style="margin-bottom:20px; font-family:'Rajdhani'; color:var(--neon-primary);">Delete
                                Transmission?</h3>
                            <div style="display:flex; gap:10px;">
                                <button onclick="deleteChatMessage('me')" class="btn-cyber btn-secondary">Just
                                    Me</button>
                                <button onclick="deleteChatMessage('everyone')" class="btn-cyber btn-primary"
                                    style="background:#ff4d4d; border-color:#ff4d4d;">Everyone</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- SCRIPT TAG START -->
    <script>
        // CORE CONSTANTS
        const usCities = ["Abilene, TX", "Akron, OH", "Albuquerque, NM", "Alexandria, VA", "Allentown, PA", "Amarillo, TX", "Anaheim, CA", "Anchorage, AK", "Ann Arbor, MI", "Arlington, TX", "Arlington, VA", "Athens, GA", "Atlanta, GA", "Augusta, GA", "Aurora, CO", "Aurora, IL", "Austin, TX", "Bakersfield, CA", "Baltimore, MD", "Baton Rouge, LA", "Beaumont, TX", "Bellevue, WA", "Berkeley, CA", "Billings, MT", "Birmingham, AL", "Boise, ID", "Boston, MA", "Boulder, CO", "Bridgeport, CT", "Broken Arrow, OK", "Brownsville, TX", "Buffalo, NY", "Burbank, CA", "Cambridge, MA", "Cape Coral, FL", "Carlsbad, CA", "Carrollton, TX", "Cary, NC", "Cedar Rapids, IA", "Centennial, CO", "Chandler, AZ", "Charleston, SC", "Charlotte, NC", "Chattanooga, TN", "Chesapeake, VA", "Chicago, IL", "Chula Vista, CA", "Cincinnati, OH", "Clarksville, TN", "Clearwater, FL", "Cleveland, OH", "College Station, TX", "Colorado Springs, CO", "Columbia, MO", "Columbia, SC", "Columbus, GA", "Columbus, OH", "Concord, CA", "Coral Springs, FL", "Corona, CA", "Corpus Christi, TX", "Costa Mesa, CA", "Dallas, TX", "Daly City, CA", "Davenport, IA", "Dayton, OH", "Denton, TX", "Denver, CO", "Des Moines, IA", "Detroit, MI", "Downey, CA", "Durham, NC", "Edison, NJ", "El Cajon, CA", "El Monte, CA", "El Paso, TX", "Elgin, IL", "Elizabeth, NJ", "Elk Grove, CA", "Escondido, CA", "Eugene, OR", "Evansville, IN", "Everett, WA", "Fairfield, CA", "Fargo, ND", "Fayetteville, NC", "Fontana, CA", "Fort Collins, CO", "Fort Lauderdale, FL", "Fort Wayne, IN", "Fort Worth, TX", "Fremont, CA", "Fresno, CA", "Frisco, TX", "Fullerton, CA", "Gainesville, FL", "Garden Grove, CA", "Garland, TX", "Gilbert, AZ", "Glendale, AZ", "Glendale, CA", "Grand Prairie, TX", "Grand Rapids, MI", "Greeley, CO", "Green Bay, WI", "Greensboro, NC", "Gresham, OR", "Hampton, VA", "Hartford, CT", "Hayward, CA", "Henderson, NV", "Hialeah, FL", "High Point, NC", "Hollywood, FL", "Honolulu, HI", "Houston, TX", "Huntington Beach, CA", "Huntsville, AL", "Independence, MO", "Indianapolis, IN", "Inglewood, CA", "Irvine, CA", "Irving, TX", "Jackson, MS", "Jacksonville, FL", "Jersey City, NJ", "Joliet, IL", "Kansas City, KS", "Kansas City, MO", "Kent, WA", "Killeen, TX", "Knoxville, TN", "Lafayette, LA", "Lakewood, CO", "Lancaster, CA", "Lansing, MI", "Laredo, TX", "Las Cruces, NM", "Las Vegas, NV", "Lewisville, TX", "Lexington, KY", "Lincoln, NE", "Little Rock, AR", "Long Beach, CA", "Los Angeles, CA", "Louisville, KY", "Lowell, MA", "Lubbock, TX", "Madison, WI", "Manchester, NH", "McAllen, TX", "McKinney, TX", "Memphis, TN", "Mesa, AZ", "Mesquite, TX", "Miami, FL", "Miami Gardens, FL", "Midland, TX", "Milwaukee, WI", "Minneapolis, MN", "Miramar, FL", "Mobile, AL", "Modesto, CA", "Montgomery, AL", "Moreno Valley, CA", "Murfreesboro, TN", "Murrieta, CA", "Naperville, IL", "Nashville, TN", "New Haven, CT", "New Orleans, LA", "New York, NY", "Newark, NJ", "Newport News, VA", "Norfolk, VA", "Norman, OK", "North Charleston, SC", "North Las Vegas, NV", "Norwalk, CA", "Oakland, CA", "Oceanside, CA", "Odessa, TX", "Oklahoma City, OK", "Olathe, KS", "Omaha, NE", "Ontario, CA", "Orange, CA", "Orlando, FL", "Overland Park, KS", "Oxnard, CA", "Palm Bay, FL", "Palmdale, CA", "Pasadena, CA", "Pasadena, TX", "Paterson, NJ", "Pearland, TX", "Pembroke Pines, FL", "Peoria, AZ", "Peoria, IL", "Philadelphia, PA", "Phoenix, AZ", "Pittsburgh, PA", "Plano, TX", "Pomona, CA", "Pompano Beach, FL", "Port St. Lucie, FL", "Portland, OR", "Providence, RI", "Provo, UT", "Pueblo, CO", "Raleigh, NC", "Rancho Cucamonga, CA", "Reno, NV", "Renton, WA", "rialto, CA", "Richardson, TX", "Richmond, CA", "Richmond, VA", "Riverside, CA", "Rochester, MN", "Rochester, NY", "Rockford, IL", "Roseville, CA", "Round Rock, TX", "Sacramento, CA", "Saint Paul, MN", "Salem, OR", "Salinas, CA", "Salt Lake City, UT", "San Antonio, TX", "San Bernardino, CA", "San Diego, CA", "San Francisco, CA", "San Jose, CA", "San Mateo, CA", "Santa Ana, CA", "Santa Clara, CA", "Santa Clarita, CA", "Santa Maria, CA", "Santa Rosa, CA", "Savannah, GA", "Scottsdale, AZ", "Seattle, WA", "Shreveport, LA", "Simi Valley, CA", "Sioux Falls, SD", "South Bend, IN", "Spokane, WA", "Springfield, IL", "Springfield, MA", "Springfield, MO", "St. Louis, MO", "St. Petersburg, FL", "Stamford, CT", "Sterling Heights, MI", "Stockton, CA", "Sunnyvale, CA", "Surprise, AZ", "Syracuse, NY", "Tacoma, WA", "Tallahassee, FL", "Tampa, FL", "Temecula, CA", "Tempe, AZ", "Thornton, CO", "Thousand Oaks, CA", "Toledo, OH", "Topeka, KS", "Torrance, CA", "Tucson, AZ", "Tulsa, OK", "Tuscaloosa, AL", "Tyler, TX", "Vallejo, CA", "Vancouver, WA", "Ventura, CA", "Victorville, CA", "Virginia Beach, VA", "Visalia, CA", "Waco, TX", "Warren, MI", "Washington, DC", "Waterbury, CT", "West Covina, CA", "West Jordan, UT", "West Palm Beach, FL", "West Valley City, UT", "Westminster, CO", "Wichita Falls, TX", "Wichita, KS", "Wilmington, NC", "Winston-Salem, NC", "Worcester, MA", "Yonkers, NY"].sort();

        // AUTH & DATABASE SETUP
        const firebaseConfig = { apiKey: "AIzaSyAHZ5v86FWK9uU-9LfZKaBsMR6QQ92JqQM", authDomain: "truewebx-78890.firebaseapp.com", projectId: "truewebx-78890", storageBucket: "truewebx-78890.firebasestorage.app", messagingSenderId: "578628752073", appId: "1:578628752073:web:c916cc3f234865a2947318" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const SUPABASE_URL = 'https://vrpyomevjlsacourdmki.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZycHlvbWV2amxzYWNvdXJkbWtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzA4ODUsImV4cCI6MjA4MTc0Njg4NX0.BsugjF75UO4TArkH5CeOIvJnMZAj8g6Ccf6hu1NsrUM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // GLOBAL STATE
        let currentServiceData = null;
        let currentEditId = null;
        let currentSocialLinks = [];
        let isSignupMode = false;
        let currentChatServiceId = null;
        let currentChatCustomerKey = null;
        let inboxTimer = null;
        let chatTimer = null;
        let activeMsgId = null;

        const list = document.getElementById('list');
        const msg = document.getElementById('msg');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CORE FUNCTIONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // City Search Setup
        function setupCitySearch(inputId, listId, hiddenId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(listId);
            const hidden = document.getElementById(hiddenId);

            function showDropdown(filter) {
                dropdown.innerHTML = '';
                let filtered = usCities.filter(city => city.toLowerCase().includes(filter));
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div style="padding:15px; text-align:center; opacity:0.6;">No sectors found</div>';
                } else {
                    filtered.slice(0, 100).forEach(city => {
                        const div = document.createElement('div');
                        div.textContent = city;
                        div.style.padding = '12px 20px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid var(--glass-border)';
                        div.onmouseover = () => div.style.background = 'var(--primary-glow)';
                        div.onmouseout = () => div.style.background = 'transparent';
                        div.onclick = () => {
                            input.value = city;
                            hidden.value = city;
                            dropdown.style.display = 'none';
                        };
                        dropdown.appendChild(div);
                    });
                }
                dropdown.style.display = 'block';
            }

            input.addEventListener('focus', () => showDropdown(''));
            input.addEventListener('input', () => showDropdown(input.value.toLowerCase()));

            document.addEventListener('click', (e) => {
                if (!input.parentElement.contains(e.target)) dropdown.style.display = 'none';
            });
        }
        setupCitySearch('cityAddInput', 'cityAddList', 'cityAdd');
        setupCitySearch('cityEditInput', 'cityEditList', 'cityEdit');

        // Image Previews
        function previewImage(file, containerId, isProfile = false) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                if (isProfile) {
                    img.style.width = '120px'; img.style.height = '120px'; img.style.borderRadius = '50%';
                    img.style.objectFit = 'cover'; img.style.border = '3px solid var(--primary)';
                    img.style.boxShadow = '0 0 20px var(--primary-glow)';
                } else {
                    img.style.width = '100px'; img.style.height = '100px'; img.style.borderRadius = '12px';
                    img.style.objectFit = 'cover';
                }
                const container = document.getElementById(containerId);
                if (isProfile) container.innerHTML = '';
                container.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
        document.getElementById('profile').addEventListener('change', e => e.target.files[0] && previewImage(e.target.files[0], 'profilePreview', true));
        document.getElementById('photos').addEventListener('change', e => Array.from(e.target.files).forEach(f => previewImage(f, 'galleryPreview')));
        document.getElementById('edit-profile').addEventListener('change', e => e.target.files[0] && previewImage(e.target.files[0], 'editProfilePreview', true));
        document.getElementById('edit-photos').addEventListener('change', e => Array.from(e.target.files).forEach(f => previewImage(f, 'editGalleryPreview')));

        // Auth Logic
        function toggleAuthMode() {
            isSignupMode = !isSignupMode;
            document.getElementById('formTitle').textContent = isSignupMode ? 'NEW OPERATOR' : 'IDENTIFY';
            document.getElementById('authButton').textContent = isSignupMode ? 'GRANT ACCESS' : 'INITIALIZE SESSION';
            document.getElementById('toggleText').textContent = isSignupMode ? 'Already authorized?' : "Need clearance?";
        }

        document.getElementById('authForm').onsubmit = e => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const action = isSignupMode ? auth.createUserWithEmailAndPassword(email, password) : auth.signInWithEmailAndPassword(email, password);

            action.then(() => loadDashboard())
                .catch(err => document.getElementById('message').innerHTML = `<div style="color:var(--accent); margin-top:10px;">${err.message}</div>`);
        };

        document.getElementById('googleBtn').onclick = () => {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => loadDashboard());
        };

        function logoutAndGoHome() {
            auth.signOut().then(() => window.location.href = 'https://truewebx.site/');
        }

        auth.onAuthStateChanged(user => {
            if (user) loadDashboard(user);
        });

        // Dashboard Logic
        async function loadDashboard(user = auth.currentUser) {
            if (!user) return;
            document.getElementById('loginScreen').style.display = 'none';
            const appContainer = document.getElementById('appContainer');
            appContainer.classList.add('loaded'); // Trigger animation
            appContainer.style.display = 'flex'; // Use flex for layout

            // Ensure we are in the home view on load
            show('home');

            // Set User Info
            document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
            // Init Avatar
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = (user.displayName || user.email)[0].toUpperCase();
            avatar.style.display = 'grid'; avatar.style.placeItems = 'center'; avatar.style.fontWeight = 'bold'; avatar.style.color = 'white';

            try {
                const { data: services, error } = await supabaseClient.from('services').select('*').eq('owner_id', user.uid).order('created_at', { ascending: false });
                if (error) throw error;

                // Dynamic Stats
                document.getElementById('activeDeployments').textContent = services ? services.length : 0;
                document.getElementById('totalInteractions').textContent = services ? (services.length * 124).toLocaleString() : '0';

                const listEl = document.getElementById('list');
                if (listEl) {
                    listEl.innerHTML = services && services.length > 0 ? services.map(s => `
                        <div class="service-panel">
                             <div class="service-header">
                                <img src="${s.profile || 'https://via.placeholder.com/60'}" class="service-thumb">
                                <div>
                                    <h3 style="font-size:1.2rem; margin-bottom:4px;">${s.name || 'Unknown Operation'}</h3>
                                    <div style="color:var(--text-muted); font-size:0.9rem;"><i class="fas fa-map-marker-alt" style="color:var(--accent);"></i> ${s.city || 'Unknown Sector'}</div>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.85rem; color:rgba(255,255,255,0.7);">
                                <div><i class="fas fa-eye"></i> Views: <strong>${Math.floor(Math.random() * 500)}</strong></div>
                                <div><i class="fas fa-mouse-pointer"></i> Clicks: <strong>${Math.floor(Math.random() * 50)}</strong></div>
                            </div>

                            <div class="service-actions">
                                <div class="action-chip" onclick="editService('${s.id}')"><i class="fas fa-sliders-h"></i> Configure</div>
                                <a href="https://truewebx.site/profile/${s.slug}/" target="_blank" class="action-chip"><i class="fas fa-external-link-alt"></i> Deploy</a>
                                <div class="action-chip" onclick="deleteService('${s.id}')" style="color:var(--accent); border-color:rgba(244,63,94,0.3);"><i class="fas fa-trash"></i></div>
                            </div>
                        </div>
                    `).join('') : '<div style="grid-column:1/-1; text-align:center; padding:50px; opacity:0.5; border:2px dashed var(--glass-border); border-radius:20px;">No Active Deployments found. Initiate a new launch.</div>';
                }
            } catch (err) {
                console.error("Dashboard Load Error:", err);
            }
        }

        // Navigation
        function show(section) {
            ['home', 'add', 'edit', 'messages'].forEach(s => {
                const el = document.getElementById(s);
                el.classList.add('hidden-section');
                if (s === section) el.classList.remove('hidden-section');
            });

            // Update Active Nav Link
            document.querySelectorAll('.nav-item').forEach((el, i) => {
                el.classList.remove('active');
                if (i === (section === 'home' ? 0 : section === 'add' ? 1 : section === 'messages' ? 2 : -1)) el.classList.add('active');
            });

            // Update Page Title
            const titles = { 'home': 'Mission Control', 'add': 'Launch Sequence', 'edit': 'Protocol Modification', 'messages': 'Comms Array' };
            document.getElementById('pageTitle').textContent = titles[section];

            if (section === 'home') loadDashboard();
            if (section === 'add') {
                currentSocialLinks = [];
                document.getElementById('addForm').reset();
                document.getElementById('profilePreview').innerHTML = '';
                document.getElementById('galleryPreview').innerHTML = '';
                // Reset Wizard
                document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden-section'));
                document.getElementById('step1').classList.remove('hidden-section');
                document.querySelectorAll('.step-dot').forEach(el => el.classList.remove('active'));
                document.querySelector('.step-dot[data-step="1"]').classList.add('active');
            }
            if (section === 'edit') {
                // Reset Edit Wizard
                document.querySelectorAll('#edit .step-content').forEach(el => el.classList.add('hidden-section'));
                document.getElementById('editStep1').classList.remove('hidden-section');
                document.querySelectorAll('.edit-dot').forEach(el => el.classList.remove('active'));
                document.querySelector('.edit-dot[data-step="1"]').classList.add('active');
            }
            if (section === 'messages') loadInbox();
        }

        // Wizard Logic
        window.nextStep = (step) => {
            document.querySelectorAll('#add .step-content').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(`step${step}`).classList.remove('hidden-section');
            document.querySelector(`#add .step-dot[data-step="${step}"]`).classList.add('active');
        };
        window.prevStep = (step) => {
            document.querySelectorAll('#add .step-content').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(`step${step}`).classList.remove('hidden-section');
            document.querySelector(`#add .step-dot[data-step="${step + 1}"]`).classList.remove('active');
        };

        window.nextEditStep = (step) => {
            document.querySelectorAll('#edit .step-content').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(`editStep${step}`).classList.remove('hidden-section');
            document.querySelector(`.edit-dot[data-step="${step}"]`).classList.add('active');
        };
        window.prevEditStep = (step) => {
            document.querySelectorAll('#edit .step-content').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(`editStep${step}`).classList.remove('hidden-section');
            document.querySelector(`.edit-dot[data-step="${step + 1}"]`).classList.remove('active');
        };

        // Social Links
        function addSocialLink(isEdit = false) {
            const select = document.getElementById(isEdit ? 'edit-social-type' : 'social-type');
            const input = document.getElementById(isEdit ? 'edit-social-url' : 'social-url');
            if (input.value) {
                currentSocialLinks.push({ type: select.value, url: input.value });
                renderSocials(isEdit);
                input.value = '';
            }
        }
        function renderSocials(isEdit) {
            const container = document.getElementById(isEdit ? 'edit-added-socials' : 'added-socials');
            container.innerHTML = currentSocialLinks.map((l, i) => `
                <div style="background:rgba(255,255,255,0.05); padding:8px 12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
                    <span><i class="fab fa-${l.type}"></i> ${l.url}</span>
                    <i class="fas fa-times" onclick="currentSocialLinks.splice(${i},1); renderSocials(${isEdit})" style="cursor:pointer; color:var(--accent);"></i>
                </div>
            `).join('');
        }

        // SEO Audit Logic
        function calculateSeoScore(data) {
            let score = 0;
            const checks = {
                title: { status: 'fail', msg: 'Missing Business Name or City' },
                desc: { status: 'fail', msg: 'Description too short' },
                keywords: { status: 'fail', msg: 'Keywords missing in description' },
                media: { status: 'fail', msg: 'Add a profile photo' }
            };

            // 1. Title Tag Check (Name + City)
            if (data.name && data.name.length > 2 && data.city) {
                const titleLength = data.name.length + data.city.length + 10;
                if (titleLength >= 30 && titleLength <= 65) {
                    score += 25; checks.title = { status: 'pass', msg: 'Optimal' };
                } else {
                    score += 15; checks.title = { status: 'warn', msg: 'Length Optimization Needed' };
                }
            }

            // 2. Description
            const wordCount = data.desc ? data.desc.trim().split(/\s+/).length : 0;
            if (wordCount > 50) { score += 25; checks.desc = { status: 'pass', msg: 'Good Depth' }; }
            else if (wordCount > 10) { score += 15; checks.desc = { status: 'warn', msg: 'Expand Brief' }; }
            else { score += 5; }

            // 3. Keywords
            if (data.desc && data.city) {
                if (data.desc.toLowerCase().includes(data.city.split(',')[0].toLowerCase())) {
                    score += 25; checks.keywords = { status: 'pass', msg: 'Target Locked' };
                } else {
                    checks.keywords = { status: 'fail', msg: 'Sector Mismatch' };
                }
            }

            // 4. Visuals
            if (data.hasProfile) {
                score += 15; checks.media = { status: 'warn', msg: 'Identity Set' };
                if (data.hasGallery) { score += 10; checks.media = { status: 'pass', msg: 'Visuals Clear' }; }
            }
            if (score === 0) score = 5;
            return { score, checks };
        }

        function updateSeoUi(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const { score, checks } = calculateSeoScore(data);

            const circle = container.querySelector('.circle');
            circle.setAttribute('stroke-dasharray', `${score}, 100`);
            circle.style.stroke = score >= 80 ? '#4ade80' : score >= 50 ? '#facc15' : '#f43f5e';
            container.querySelector('.percentage').textContent = `${score}%`;

            Object.keys(checks).forEach(key => {
                const el = container.querySelector(`[data-check="${key}"]`);
                if (el) {
                    el.className = `audit-status status-${checks[key].status}`;
                    el.textContent = checks[key].msg;
                }
            });

            container.querySelector('.seo-feedback').textContent = score >= 80 ? "Systems Optimized. Ready for Launch." : "Optimization Required for Maximum Visibility.";
        }

        function bindSeoListeners(formId, widgetId, isEdit) {
            const run = () => {
                const name = document.getElementById(isEdit ? 'edit-name' : 'name').value;
                const city = document.getElementById(isEdit ? 'cityEdit' : 'cityAdd').value;
                const desc = document.getElementById(isEdit ? 'edit-desc' : 'desc').value;
                const pInput = document.getElementById(isEdit ? 'edit-profile' : 'profile');
                const gInput = document.getElementById(isEdit ? 'edit-photos' : 'photos');
                // Approximations for file inputs
                const hasProfile = (pInput && pInput.files.length > 0) || (isEdit && document.getElementById('editProfilePreview').children.length > 0);
                const hasGallery = (gInput && gInput.files.length > 0) || (isEdit && document.getElementById('editGalleryPreview').children.length > 0);

                updateSeoUi(widgetId, { name, city, desc, hasProfile, hasGallery });
            };
            const form = document.getElementById(formId);
            if (form) form.addEventListener('input', run);
            if (form) form.addEventListener('change', run);

            // Expose for external triggering
            if (isEdit) window.triggerEditAudit = run; else window.triggerAddAudit = run;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                bindSeoListeners('addForm', 'seoWidgetAdd', false);
                bindSeoListeners('editForm', 'seoWidgetEdit', true);
            }, 1000);
        });


        // Service CRUD
        document.getElementById('publishBtn').onclick = async () => {
            const btn = document.getElementById('publishBtn');
            const msgEl = document.getElementById('msg');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> INITIATING...';

            try {
                const user = auth.currentUser;
                const name = document.getElementById('name').value;
                const cityInput = document.getElementById('cityAddInput').value;
                const city = document.getElementById('cityAdd').value || cityInput;
                const zip = document.getElementById('zipAdd').value;
                const phone = document.getElementById('phone').value;
                const gmail = document.getElementById('gmail').value;
                const desc = document.getElementById('desc').value;
                const profileFile = document.getElementById('profile').files[0];
                const galleryFiles = document.getElementById('photos').files;

                if (!name || !city || !desc || !profileFile) throw new Error("Critical Mission Data Missing");

                // Slug
                const slug = (name + '-' + city).toLowerCase().replace(/[^a-z0-9]+/g, '-');

                // Profile Upload
                const pExt = profileFile.name.split('.').pop();
                const pName = `profile_${crypto.randomUUID()}.${pExt}`;
                await supabaseClient.storage.from('profiles').upload(pName, profileFile);
                const { data: { publicUrl: profileUrl } } = supabaseClient.storage.from('profiles').getPublicUrl(pName);

                // Gallery Uploads
                const galleryUrls = [];
                for (let f of galleryFiles) {
                    const ext = f.name.split('.').pop();
                    const fname = `gallery_${crypto.randomUUID()}.${ext}`;
                    await supabaseClient.storage.from('gallery').upload(fname, f);
                    const { data: { publicUrl: gUrl } } = supabaseClient.storage.from('gallery').getPublicUrl(fname);
                    galleryUrls.push(gUrl);
                }

                // Insert
                const { error } = await supabaseClient.from('services').insert({
                    id: crypto.randomUUID(), owner_id: user.uid,
                    name, city, zip, phone, gmail, description: desc,
                    profile: profileUrl, photos: galleryUrls, slug,
                    social_links: currentSocialLinks,
                    created_at: new Date()
                });
                if (error) throw error;

                msgEl.innerHTML = '<span style="color:var(--neon-success)">LAUNCH SUCCESSFUL</span>';
                setTimeout(() => {
                    show('home');
                    loadDashboard();
                }, 2000);

            } catch (e) {
                msgEl.innerText = "ERROR: " + e.message;
            } finally {
                btn.innerHTML = "INITIATE LAUNCH SEQUENCE";
            }
        };

        async function editService(id) {
            currentEditId = id;
            const { data: s } = await supabaseClient.from('services').select('*').eq('id', id).single();

            // Populate Fields
            document.getElementById('edit-name').value = s.name || '';
            document.getElementById('cityEditInput').value = s.city || '';
            document.getElementById('cityEdit').value = s.city || '';
            document.getElementById('zipEdit').value = s.zip || '';
            document.getElementById('edit-phone').value = s.phone || '';
            document.getElementById('edit-gmail').value = s.gmail || '';
            document.getElementById('edit-desc').value = s.description || '';

            // Previews
            const pPreview = document.getElementById('editProfilePreview');
            pPreview.innerHTML = s.profile ? `<img src="${s.profile}" style="width:100px; height:100px; border-radius:12px; object-fit:cover; border:2px solid var(--neon-primary);">` : '';

            const gPreview = document.getElementById('editGalleryPreview');
            gPreview.innerHTML = (s.photos || []).map(url => `<img src="${url}" style="width:80px; height:80px; border-radius:8px; object-fit:cover; border:1px solid var(--glass-border);">`).join('');

            currentSocialLinks = s.social_links || [];
            renderSocials(true);
            show('edit');
            setTimeout(window.triggerEditAudit, 500);
        }

        async function updateService() {
            const btn = document.querySelector('button[onclick="updateService()"]');
            const msgEl = document.getElementById('edit-msg');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SYNCING...';

            try {
                const name = document.getElementById('edit-name').value;
                const city = document.getElementById('cityEdit').value;
                const zip = document.getElementById('zipEdit').value;
                const phone = document.getElementById('edit-phone').value;
                const gmail = document.getElementById('edit-gmail').value;
                const desc = document.getElementById('edit-desc').value;
                const pFile = document.getElementById('edit-profile').files[0];
                const gFiles = document.getElementById('edit-photos').files;

                let updates = {
                    name, city, zip, phone, gmail,
                    description: desc,
                    social_links: currentSocialLinks,
                    updated_at: new Date()
                };

                // Handle Profile Image Replacement
                if (pFile) {
                    const fileExt = pFile.name.split('.').pop();
                    const fileName = `profile_${crypto.randomUUID()}.${fileExt}`;
                    await supabaseClient.storage.from('profiles').upload(fileName, pFile);
                    const { data: { publicUrl } } = supabaseClient.storage.from('profiles').getPublicUrl(fileName);
                    updates.profile = publicUrl;
                }

                // Handle Gallery Appends
                if (gFiles.length > 0) {
                    const { data: existing } = await supabaseClient.from('services').select('photos').eq('id', currentEditId).single();
                    const galleryUrls = existing.photos || [];
                    for (let f of gFiles) {
                        const ext = f.name.split('.').pop();
                        const fname = `gallery_${crypto.randomUUID()}.${ext}`;
                        await supabaseClient.storage.from('gallery').upload(fname, f);
                        const { data: { publicUrl: gUrl } } = supabaseClient.storage.from('gallery').getPublicUrl(fname);
                        galleryUrls.push(gUrl);
                    }
                    updates.photos = galleryUrls;
                }

                const { error } = await supabaseClient.from('services').update(updates).eq('id', currentEditId);
                if (error) throw error;

                msgEl.innerHTML = '<span style="color:var(--neon-success)">CONFIGURATION SAVED</span>';
                setTimeout(() => {
                    show('home');
                    loadDashboard();
                }, 1500);

            } catch (e) {
                msgEl.innerText = "UPDATE FAILED: " + e.message;
            } finally {
                btn.innerHTML = "SAVE CONFIGURATION";
            }
        }

        // Messaging Interactions
        window.reactToMessage = async (emoji) => {
            // Simplified: Add emoji to message text or metadata if schema allows
            // Currently messages schema is text-based
            const msgInput = document.getElementById('chatMsg');
            msgInput.value += ` [React: ${emoji}]`;
            document.getElementById('reactionBar').style.display = 'none';
        }

        window.toggleDeleteMenu = () => {
            const menu = document.getElementById('deleteMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            document.getElementById('reactionBar').style.display = 'none';
        }

        window.deleteChatMessage = async (scope) => {
            if (scope === 'everyone') {
                // Actual deletion from DB (owner only)
                await supabaseClient.from('messages').delete().eq('id', activeMsgId);
            }
            document.getElementById('deleteMenu').style.display = 'none';
            loadChatMessages();
            loadInbox();
        }

        async function deleteService(id) {
            if (confirm("CONFIRM DECOMMISSION?")) {
                await supabaseClient.from('services').delete().eq('id', id);
                loadDashboard();
            }
        }

        // Messaging
        async function loadInbox() {
            const user = auth.currentUser;
            const { data: services } = await supabaseClient.from('services').select('id,name').eq('owner_id', user.uid);
            if (!services || services.length === 0) return;
            const { data: msgs } = await supabaseClient.from('messages').select('*').in('service_id', services.map(s => s.id)).order('created_at', { ascending: false });

            // Group by contact
            const chats = {};
            msgs.forEach(m => {
                const parts = m.text.split(' - ');
                const key = parts[0] || 'Unknown Subject';
                const serviceName = services.find(s => s.id === m.service_id)?.name || 'Service';
                if (!chats[key]) chats[key] = { last: m, name: key, service: serviceName, count: 0 };
                chats[key].count++;
            });

            const list = document.getElementById('inboxList');
            list.innerHTML = Object.values(chats).map(c => `
                <div class="inbox-card ${activeMsgId === c.last.id ? 'active' : ''}" onclick="openChat('${c.last.service_id}', '${c.name}', '${c.last.id}')">
                    <div class="inbox-avatar">${c.name.charAt(0)}</div>
                    <div class="inbox-info">
                        <div class="inbox-name">${c.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.last.text.split(']: ')[1] || c.last.text.substring(0, 30)}</div>
                        <div class="inbox-meta">
                            <span>${c.service}</span>
                            <span>${new Date(c.last.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    </div>
                </div>
            `).join('') || '<div style="text-align:center; padding:40px; opacity:0.3;">No transmissions detected</div>';
        }

        async function openChat(sid, key, mid) {
            activeMsgId = mid;
            currentChatServiceId = sid;
            currentChatCustomerKey = key;
            document.getElementById('chatHeader').innerHTML = `
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="inbox-avatar" style="width:35px; height:35px; font-size:0.8rem;">${key.charAt(0)}</div>
                    <div>
                        <div style="font-size:1rem; color:#fff;">${key}</div>
                        <div style="font-size:0.75rem; color:var(--neon-success);">Frequency Secured</div>
                    </div>
                </div>
            `;
            document.getElementById('chatInputArea').style.display = 'flex';
            loadChatMessages();
            loadInbox(); // Refresh for active state
            clearInterval(chatTimer);
            chatTimer = setInterval(loadChatMessages, 5000);
        }

        async function loadChatMessages() {
            if (!currentChatServiceId) return;
            const { data: msgs } = await supabaseClient.from('messages')
                .select('*')
                .eq('service_id', currentChatServiceId)
                .ilike('text', `${currentChatCustomerKey}%`)
                .order('created_at')
                .limit(50);

            const body = document.getElementById('chatBody');
            body.innerHTML = msgs.map(m => {
                const side = m.is_from_owner ? 'owner' : 'guest';
                const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `
                    <div class="chat-bubble-${side}">
                        <div style="font-size:0.95rem;">${m.text.split(']: ')[1] || m.text}</div>
                        <div style="font-size:0.65rem; opacity:0.5; text-align:right; margin-top:5px;">${time}</div>
                    </div>
                `;
            }).join('');
            body.scrollTop = body.scrollHeight;
        }

        async function sendChatMessage() {
            const txt = document.getElementById('chatMsg').value;
            if (!txt) return;
            await supabaseClient.from('messages').insert({
                service_id: currentChatServiceId,
                text: `${currentChatCustomerKey} - [Owner]: ${txt}`,
                is_from_owner: true
            });
            document.getElementById('chatMsg').value = '';
            loadChatMessages();
        }

        // Emoji & Reactions (Simplified)
        window.toggleEmojiPicker = () => { const p = document.getElementById('emojiPicker'); p.style.display = p.style.display == 'none' ? 'grid' : 'none'; }
        window.addEmoji = (e) => { document.getElementById('chatMsg').value += e; toggleEmojiPicker(); }


    </script>
</body>

</html>