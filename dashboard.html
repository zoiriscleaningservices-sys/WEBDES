<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueWebX – My Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Square Web Payments SDK removed by user request -->

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <style>
        :root {
            --coral: #ff6b6b;
            --turquoise: #0d9488;
            --glass-bg: rgba(255, 255, 255, 0.18);
            --dark-glass: rgba(30, 30, 50, 0.85);
            --text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--turquoise), var(--coral));
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            padding: 20px;
        }

        .form {
            width: 100%;
            max-width: 450px;
            background: #ffffff;
            color: #151717;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, .15);
            text-align: center;
        }

        .inputForm {
            height: 56px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            background: white;
        }

        .inputForm:focus-within {
            border-color: #2d79f3;
            box-shadow: 0 0 0 3px rgba(45, 121, 243, 0.15);
        }

        .input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            font-size: 16px;
            color: #151717;
            outline: none;
        }

        .input::placeholder {
            color: #aaa;
        }

        .button-submit {
            background: #151717;
            color: white;
            height: 56px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            border: none;
            transition: all 0.2s;
        }

        .button-submit:hover:not(:disabled) {
            background: #2d79f3;
            transform: translateY(-2px);
        }

        .button-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn.google {
            background: white;
            border: 2px solid #e0e0e0;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            color: #151717;
        }

        .btn.google:hover {
            border-color: #2d79f3;
        }

        .error {
            color: #e74c3c;
            background: #fff5f5;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }

        .toggle-link {
            color: #2d79f3;
            cursor: pointer;
            font-weight: 600;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 30px;
            display: flex;
            gap: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 24px;
        }

        .nav-item.active,
        .nav-item.active i {
            color: var(--coral);
            transform: scale(1.15);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            padding-top: 80px;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo {
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 900;
            background: linear-gradient(45deg, #fff, #ff8fa3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 32px;
            margin: 20px 0;
            width: 100%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .form-grid {
            display: grid;
            gap: 20px;
            width: 100%;
        }

        input,
        textarea,
        select,
        button {
            padding: 18px;
            border-radius: 20px;
            border: none;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(10px);
            width: 100%;
        }

        input::placeholder,
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        select {
            appearance: none;
            padding-right: 50px;
            cursor: pointer;
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: white;
            font-size: 18px;
        }

        button {
            background: var(--coral);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #ff8787;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Searchable City Select – DARK & HIGH CONTRAST (100% VISIBLE) */
        .searchable-select {
            position: relative;
            width: 100%;
        }

        .searchable-select input {
            padding-right: 50px;
            width: 100%;
        }

        .searchable-select .dropdown-list {
            position: absolute;
            top: 100%;
            margin-top: 12px;
            left: 0;
            right: 0;
            max-height: 360px;
            overflow-y: auto;
            background: #0f0f1a;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            border: 2px solid #333;
        }

        .searchable-select .dropdown-list div {
            padding: 20px 24px;
            cursor: pointer;
            transition: background 0.25s;
            color: #ffffff;
            font-size: 16px;
            border-bottom: 1px solid #333;
        }

        .searchable-select .dropdown-list div:last-child {
            border-bottom: none;
        }

        .searchable-select .dropdown-list div:hover {
            background: var(--coral);
        }

        .searchable-select .no-results {
            padding: 20px 24px;
            text-align: center;
            color: #ff6b6b;
            font-style: italic;
            font-weight: bold;
        }

        .photo-upload {
            position: relative;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 28px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .photo-upload:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: var(--coral);
            transform: translateY(-4px);
        }

        .photo-upload i {
            font-size: 48px;
            color: var(--coral);
            margin-bottom: 12px;
        }

        .photo-upload span {
            font-size: 18px;
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }

        .photo-upload small {
            font-size: 14px;
            opacity: 0.85;
        }

        .photo-upload input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .preview-container {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .preview-img {
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .profile-preview {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border-radius: 50%;
            border: 5px solid var(--coral);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .services {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-top: 20px;
            width: 100%;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 24px;
            position: relative;
            width: 100%;
            text-align: center;
        }

        .card img.profile-img {
            width: 100%;
            max-width: 320px;
            border-radius: 20px;
            margin: 16px auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .card h3 {
            margin: 16px 0 8px;
            font-size: 1.6rem;
        }

        .card p {
            margin: 10px 0;
            line-height: 1.6;
            opacity: 0.95;
        }

        .card .photos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .card .photos img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .edit,
        .delete {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #ffeb3b;
            color: black;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            cursor: pointer;
            font-size: 22px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .delete {
            background: red;
            color: white;
            right: 72px;
        }

        .card:hover .edit,
        .card:hover .delete {
            opacity: 1;
        }

        .private {
            filter: blur(6px);
            user-select: none;
            transition: filter 0.3s;
            font-weight: 500;
        }

        .private:hover,
        .private:focus {
            filter: none;
        }

        .links {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .links a {
            color: var(--coral);
            text-decoration: none;
            font-weight: 600;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .social-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .social-input select,
        .social-input input {
            flex: 1;
        }

        .social-input button {
            flex: 0 0 56px;
            height: 56px;
            background: #0d9488;
            color: white;
            font-size: 24px;
            border-radius: 20px;
        }

        .added-link {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 20px;
        }

        .added-link i {
            font-size: 20px;
        }

        .added-link button {
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
        }

        .inbox-list {
            display: grid;
            gap: 16px;
        }

        .inbox-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 16px;
            cursor: pointer;
            transition: 0.3s;
        }

        .inbox-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-4px);
        }

        .inbox-item.unread {
            border-left: 4px solid var(--coral);
        }

        .chat-window {
            display: none;
            flex-direction: column;
            height: 70vh;
            margin-top: 20px;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.4;
        }

        .message.client {
            align-self: flex-end;
            background: var(--coral);
            color: white;
        }

        .message.owner {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.3);
        }

        .message small {
            display: block;
            margin-top: 6px;
            opacity: 0.7;
            font-size: 0.8em;
        }

        .chat-input {
            display: flex;
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 14px;
            border-radius: 50px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--coral);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
        }


        @media (max-width: 768px) {
            .glass {
                padding: 24px;
            }

            .preview-img {
                max-width: 100px;
                max-height: 100px;
            }

            .profile-preview {
                width: 130px;
                height: 130px;
            }

            .card img.profile-img {
                max-width: 260px;
            }

            .payment-modal {
                padding: 32px 20px;
            }

            .price-big {
                font-size: 3rem;
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN / SIGN UP (exactly the same) -->
    <div id="loginScreen" class="login-container">
        <div class="form">
            <h2 style="margin-bottom:30px; color:#151717;" id="formTitle">Sign In</h2>

            <form id="authForm">
                <div class="inputForm">
                    <input id="email" placeholder="Your email" class="input" type="email" required>
                </div>

                <div class="inputForm">
                    <input id="password" placeholder="Your password" class="input" type="password" required>
                </div>

                <button type="submit" class="button-submit" id="authButton">Sign In</button>
            </form>

            <div id="message"></div>

            <p style="margin-top:20px; color:#666;">
                <span id="toggleText">Don't have an account?</span>
                <span class="toggle-link" onclick="toggleAuthMode()">Sign up here</span>
            </p>

            <div style="margin-top:20px;">
                <button type="button" class="btn google" id="googleBtn">
                    <svg width="20" height="20" viewBox="0 0 512 512" fill="currentColor">
                        <path
                            d="M113.47,309.408L95.648,375.94l-65.139,1.378C11.042,341.211,0,299.9,0,256 c0-42.451,10.324-82.483,28.624-117.732h0.014l57.992,10.632l25.404,57.644c-5.317,15.501-8.215,32.141-8.215,49.456 C103.821,274.792,107.225,292.797,113.47,309.408z"
                            style="fill:#FBBB00;"></path>
                        <path
                            d="M507.527,208.176C510.467,223.662,512,239.655,512,256c0,18.328-1.927,36.206-5.598,53.451 c-12.462,58.683-45.025,109.925-90.134,146.187l-0.014-0.014l-73.044-3.727l-10.338-64.535 c29.932-17.554,53.324-45.025,65.646-77.911h-136.89V208.176h138.887L507.527,208.176z"
                            style="fill:#518EF8;"></path>
                        <path
                            d="M416.253,455.624l0.014,0.014C372.396,490.901,316.666,512,256,512 c-97.491,0-182.252-54.491-225.491-134.681l82.961-67.91c21.619,57.698,77.278,98.771,142.53,98.771 c28.047,0,54.323-7.582,76.87-20.818L416.253,455.624z"
                            style="fill:#28B446;"></path>
                        <path
                            d="M419.404,58.936l-82.933,67.896c-23.335-14.586-50.919-23.012-80.471-23.012 c-66.729,0-123.429,42.957-143.965,102.724l-83.397-68.276h-0.014C71.23,56.123,157.06,0,256,0 C318.115,0,375.068,22.126,419.404,58.936z"
                            style="fill:#F14336;"></path>
                    </svg>
                    Continue with Google
                </button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD (exactly the same) -->
    <div id="dashboardScreen" style="display:none;">
        <div class="bottom-nav">
            <div class="nav-container">
                <div class="nav-item active" onclick="show('home')"><i class="fas fa-home"></i><span>My Services</span>
                </div>
                <div class="nav-item" onclick="show('add')"><i class="fas fa-plus-circle"></i><span>New</span></div>
                <div class="nav-item" onclick="show('messages')"><i class="fas fa-envelope"></i><span>Messages</span>
                </div>
                <div class="nav-item" onclick="logoutAndGoHome()"><i class="fas fa-sign-out-alt"></i><span>Sign
                        Out</span></div>
            </div>
        </div>

        <div class="main-content">
            <h1 class="logo">TrueWebX</h1>
            <p style="text-align:center; margin-bottom:30px;" id="welcomeMsg"></p>

            <div id="home" class="glass">
                <h2 style="text-align:center; margin-bottom:24px;">My Published Services</h2>
                <div class="services" id="list"></div>
            </div>

            <div id="add" class="glass" style="display:none;">
                <h2>Publish New Service</h2>
                <form class="form-grid" id="addForm">
                    <input type="text" id="name" placeholder="Business / Company Name" required>

                    <div class="searchable-select">
                        <input type="text" id="cityAddInput" placeholder="Search any US city (e.g. Mobile, AL)"
                            autocomplete="off" required>
                        <div class="dropdown-list" id="cityAddList"></div>
                        <input type="hidden" id="cityAdd" required>
                    </div>

                    <input type="text" id="zipAdd" placeholder="ZIP Code (optional, 5 digits)" maxlength="5">

                    <input type="tel" id="phone" placeholder="Phone Number" required>
                    <input type="email" id="gmail" placeholder="Email" required>
                    <textarea id="desc" placeholder="Detailed Description" rows="5" required></textarea>

                    <div class="photo-upload">
                        <i class="fas fa-camera"></i>
                        <span>Upload Profile Photo / Logo</span>
                        <small>(Required – one image)</small>
                        <input type="file" id="profile" accept="image/*" required>
                        <div class="preview-container" id="profilePreview"></div>
                    </div>

                    <div class="photo-upload">
                        <i class="fas fa-images"></i>
                        <span>Upload Gallery Photos</span>
                        <small>(Optional – select multiple)</small>
                        <input type="file" id="photos" accept="image/*" multiple>
                        <div class="preview-container" id="galleryPreview"></div>
                    </div>

                    <div id="social-container">
                        <h3 style="margin:20px 0 10px;">Social Media (optional)</h3>
                        <div class="social-input">
                            <select id="social-type">
                                <option value="instagram">Instagram</option>
                                <option value="tiktok">TikTok</option>
                                <option value="facebook">Facebook</option>
                                <option value="twitter">X (Twitter)</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="youtube">YouTube</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="other">Other</option>
                            </select>
                            <input type="url" id="social-url" placeholder="Full URL">
                            <button type="button" onclick="addSocialLink()">+</button>
                        </div>
                        <div id="added-socials"></div>
                    </div>

                    <button type="button" id="publishBtn">PUBLISH NOW</button>
                </form>
                <p id="msg"></p>
            </div>

            <div id="edit" class="glass" style="display:none;">
                <h2>Edit Service</h2>
                <form class="form-grid" id="editForm">
                    <input type="text" id="edit-name" placeholder="Business / Company Name" required>

                    <div class="searchable-select">
                        <input type="text" id="cityEditInput" placeholder="Search any US city (e.g. Mobile, AL)"
                            autocomplete="off" required>
                        <div class="dropdown-list" id="cityEditList"></div>
                        <input type="hidden" id="cityEdit" required>
                    </div>

                    <input type="text" id="zipEdit" placeholder="ZIP Code (optional, 5 digits)" maxlength="5">

                    <input type="tel" id="edit-phone" placeholder="Phone Number" required>
                    <input type="email" id="edit-gmail" placeholder="Email" required>
                    <textarea id="edit-desc" placeholder="Detailed Description" rows="5" required></textarea>

                    <div class="photo-upload">
                        <i class="fas fa-camera"></i>
                        <span>Change Profile Photo / Logo</span>
                        <small>(Optional)</small>
                        <input type="file" id="edit-profile" accept="image/*">
                        <div class="preview-container" id="editProfilePreview"></div>
                    </div>

                    <div class="photo-upload">
                        <i class="fas fa-images"></i>
                        <span>Add More Gallery Photos</span>
                        <small>(Optional)</small>
                        <input type="file" id="edit-photos" accept="image/*" multiple>
                        <div class="preview-container" id="editGalleryPreview"></div>
                    </div>

                    <div id="edit-social-container">
                        <h3 style="margin:20px 0 10px;">Social Media</h3>
                        <div class="social-input">
                            <select id="edit-social-type">
                                <option value="instagram">Instagram</option>
                                <option value="tiktok">TikTok</option>
                                <option value="facebook">Facebook</option>
                                <option value="twitter">X (Twitter)</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="youtube">YouTube</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="other">Other</option>
                            </select>
                            <input type="url" id="edit-social-url" placeholder="Full URL">
                            <button type="button" onclick="addSocialLink(true)">+</button>
                        </div>
                        <div id="edit-added-socials"></div>
                    </div>

                    <button type="button" onclick="updateService()">SAVE CHANGES</button>
                </form>
                <p id="edit-msg"></p>
            </div>

            <div id="messages" class="glass" style="display:none;">
                <h2>Messages</h2>
                <div id="inboxList" class="inbox-list"></div>

                <div id="chatWindow" class="glass chat-window">
                    <div class="chat-header" id="chatHeader">Select a conversation</div>
                    <div class="chat-body" id="chatBody"></div>
                    <div class="chat-input">
                        <input type="text" id="replyInput" placeholder="Type your reply...">
                        <button onclick="sendReply()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ────────────────────────────────────────────────
        // YOUR ORIGINAL CONSTANTS & SETUP – 100% UNCHANGED
        // ────────────────────────────────────────────────
        const usCities = [
            "Abilene, TX", "Akron, OH", "Alameda, CA", "Albany, GA", "Albany, NY", "Albuquerque, NM", "Alexandria, LA", "Alexandria, VA", "Alhambra, CA", "Allen, TX",
            "Allentown, PA", "Alpharetta, GA", "Altamonte Springs, FL", "Altoona, PA", "Ames, IA", "Anaheim, CA", "Anchorage, AK", "Anderson, IN", "Ann Arbor, MI", "Annapolis, MD",
            "Antioch, CA", "Apache Junction, AZ", "Apex, NC", "Apple Valley, CA", "Apple Valley, MN", "Appleton, WI", "Arcadia, CA", "Arlington, TX", "Arlington, VA", "Arvada, CO",
            "Asheville, NC", "Athens, GA", "Atlanta, GA", "Atlantic City, NJ", "Attleboro, MA", "Auburn, AL", "Auburn, WA", "Augusta, GA", "Aurora, CO", "Aurora, IL",
            "Austin, TX", "Avondale, AZ", "Azusa, CA", "Bakersfield, CA", "Baldwin Park, CA", "Baltimore, MD", "Bangor, ME", "Barnstable Town, MA", "Bartlett, TN", "Baton Rouge, LA",
            "Battle Creek, MI", "Bayonne, NJ", "Baytown, TX", "Beaumont, TX", "Beavercreek, OH", "Bedford, TX", "Bell Gardens, CA", "Bellevue, WA", "Bellflower, CA", "Bellingham, WA",
            "Bend, OR", "Bentonville, AR", "Berkeley, CA", "Berwyn, IL", "Bethlehem, PA", "Billings, MT", "Birmingham, AL", "Bismarck, ND", "Blacksburg, VA", "Blaine, MN",
            "Bloomington, IL", "Bloomington, IN", "Bloomington, MN", "Boca Raton, FL", "Boise, ID", "Bolingbrook, IL", "Bonita Springs, FL", "Bossier City, LA", "Boston, MA", "Boulder, CO",
            "Bowling Green, KY", "Boynton Beach, FL", "Bradenton, FL", "Brea, CA", "Brentwood, CA", "Brentwood, TN", "Bridgeport, CT", "Bristol, CT", "Brockton, MA", "Broken Arrow, OK",
            "Brookhaven, GA", "Broomfield, CO", "Brownsville, TX", "Bryan, TX", "Buckeye, AZ", "Buena Park, CA", "Buffalo, NY", "Burbank, CA", "Burien, WA", "Burleson, TX",
            "Burlington, NC", "Burlington, VT", "Caldwell, ID", "Camarillo, CA", "Cambridge, MA", "Camden, NJ", "Campbell, CA", "Canton, OH", "Cape Coral, FL", "Carlsbad, CA",
            "Carmel, IN", "Carson, CA", "Carson City, NV", "Cary, NC", "Casa Grande, AZ", "Casper, WY", "Castle Rock, CO", "Cathedral City, CA", "Cedar Park, TX", "Cedar Rapids, IA",
            "Centennial, CO", "Central Islip, NY", "Cerritos, CA", "Champaign, IL", "Chandler, AZ", "Chapel Hill, NC", "Charleston, SC", "Charlotte, NC", "Charlottesville, VA", "Chattanooga, TN",
            "Chelsea, MA", "Cherry Hill, NJ", "Chesapeake, VA", "Chesterfield, MO", "Cheyenne, WY", "Chicago, IL", "Chico, CA", "Chino, CA", "Chino Hills, CA", "Chula Vista, CA",
            "Cicero, IL", "Cincinnati, OH", "Citrus Heights, CA", "Clarksville, TN", "Clearwater, FL", "Cleveland, OH", "Cleveland Heights, OH", "Clifton, NJ", "Clovis, CA", "Clovis, NM",
            "Coachella, CA", "Coconut Creek, FL", "Coeur d'Alene, ID", "College Station, TX", "Colorado Springs, CO", "Columbia, MO", "Columbia, SC", "Columbus, GA", "Columbus, OH", "Commerce City, CO",
            "Compton, CA", "Concord, CA", "Concord, NC", "Conroe, TX", "Conway, AR", "Coon Rapids, MN", "Coral Gables, FL", "Coral Springs, FL", "Corona, CA", "Corpus Christi, TX",
            "Costa Mesa, CA", "Council Bluffs, IA", "Covina, CA", "Cranston, RI", "Cupertino, CA", "Cutler Bay, FL", "Cuyahoga Falls, OH", "Cypress, CA", "Dallas, TX", "Daly City, CA",
            "Danbury, CT", "Danville, CA", "Danville, VA", "Davenport, IA", "Davie, FL", "Dayton, OH", "Daytona Beach, FL", "DeKalb, IL", "Deerfield Beach, FL", "Delray Beach, FL",
            "Deltona, FL", "Denver, CO", "Des Moines, IA", "Des Plaines, IL", "Detroit, MI", "Doral, FL", "Dothan, AL", "Downey, CA", "Draper, UT", "Dublin, CA", "Dublin, OH",
            "Dubuque, IA", "Duluth, MN", "Duncanville, TX", "Dunedin, FL", "Durham, NC", "Eagan, MN", "East Lansing, MI", "East Orange, NJ", "Eau Claire, WI", "Edina, MN",
            "Edinburg, TX", "Edmond, OK", "El Cajon, CA", "El Centro, CA", "El Monte, CA", "El Paso, TX", "Elgin, IL", "Elizabeth, NJ", "Elk Grove, CA", "Elmhurst, IL",
            "Elyria, OH", "Encinitas, CA", "Enid, OK", "Erie, PA", "Escondido, CA", "Eugene, OR", "Euless, TX", "Euclid, OH", "Evanston, IL", "Evansville, IN",
            "Everett, MA", "Everett, WA", "Fairfield, CA", "Fargo, ND", "Farmington Hills, MI", "Fayetteville, AR", "Fayetteville, NC", "Federal Way, WA", "Findlay, OH", "Fishers, IN",
            "Flagstaff, AZ", "Flint, MI", "Florence, AL", "Florissant, MO", "Flower Mound, TX", "Folsom, CA", "Fontana, CA", "Fort Collins, CO", "Fort Lauderdale, FL", "Fort Myers, FL",
            "Fort Pierce, FL", "Fort Smith, AR", "Fort Wayne, IN", "Fort Worth, TX", "Fountain Valley, CA", "Fremont, CA", "Fresno, CA", "Frisco, TX", "Fullerton, CA", "Gainesville, FL",
            "Gaithersburg, MD", "Galveston, TX", "Garden Grove, CA", "Gardena, CA", "Garland, TX", "Gary, IN", "Gastonia, NC", "Georgetown, TX", "Germantown, TN", "Gilbert, AZ",
            "Glendale, AZ", "Glendale, CA", "Glendora, CA", "Goodyear, AZ", "Grand Forks, ND", "Grand Island, NE", "Grand Junction, CO", "Grand Prairie, TX", "Grand Rapids, MI", "Grapevine, TX",
            "Great Falls, MT", "Greeley, CO", "Green Bay, WI", "Greensboro, NC", "Greenville, NC", "Greenville, SC", "Greenwood, IN", "Gulfport, MS", "Hackensack, NJ", "Hagerstown, MD",
            "Hallandale Beach, FL", "Hamilton, OH", "Hammond, IN", "Hampton, VA", "Hanford, CA", "Harrisburg, PA", "Harrisonburg, VA", "Hartford, CT", "Hattiesburg, MS", "Haverhill, MA",
            "Hawthorne, CA", "Hayward, CA", "Hemet, CA", "Hempstead, NY", "Henderson, NV", "Hesperia, CA", "Hialeah, FL", "Hickory, NC", "High Point, NC", "Highland, CA",
            "Hillsboro, OR", "Hilton Head Island, SC", "Hoboken, NJ", "Hoffman Estates, IL", "Hollywood, FL", "Holyoke, MA", "Homestead, FL", "Hoover, AL", "Houston, TX", "Huntington, NY",
            "Huntington Beach, CA", "Huntsville, AL", "Idaho Falls, ID", "Independence, MO", "Indianapolis, IN", "Indio, CA", "Inglewood, CA", "Iowa City, IA", "Irvine, CA", "Irving, TX",
            "Jackson, MS", "Jackson, TN", "Jacksonville, FL", "Jacksonville, NC", "Janesville, WI", "Jeffersonville, IN", "Jersey City, NJ", "Johns Creek, GA", "Joliet, IL", "Jonesboro, AR",
            "Joplin, MO", "Jupiter, FL", "Kalamazoo, MI", "Kannapolis, NC", "Kansas City, KS", "Kansas City, MO", "Kearny, NJ", "Keller, TX", "Kennewick, WA", "Kenner, LA",
            "Kenosha, WI", "Kent, WA", "Kettering, OH", "Killeen, TX", "Kingsport, TN", "Kirkland, WA", "Kissimmee, FL", "Knoxville, TN", "La Crosse, WI", "La Habra, CA",
            "La Mesa, CA", "La Mirada, CA", "La Puente, CA", "Lacey, WA", "Lafayette, IN", "Lafayette, LA", "Laguna Niguel, CA", "Lake Charles, LA", "Lake Elsinore, CA", "Lake Forest, CA",
            "Lake Havasu City, AZ", "Lakeland, FL", "Lakeville, MN", "Lakewood, CA", "Lakewood, CO", "Lakewood, NJ", "Lakewood, OH", "Lakewood, WA", "Lancaster, CA", "Lancaster, PA",
            "Lansing, MI", "Laredo, TX", "Largo, FL", "Las Cruces, NM", "Las Vegas, NV", "Lauderhill, FL", "Lawrence, KS", "Lawrence, MA", "Lawton, OK", "Layton, UT",
            "League City, TX", "Lee's Summit, MO", "Lehi, UT", "Lenexa, KS", "Levittown, NY", "Lewiston, ME", "Lewisville, TX", "Lexington, KY", "Lincoln, NE", "Little Rock, AR",
            "Littleton, CO", "Livermore, CA", "Lodi, CA", "Logan, UT", "Long Beach, CA", "Longmont, CO", "Longview, TX", "Lorain, OH", "Los Angeles, CA", "Louisville, KY",
            "Loveland, CO", "Lowell, MA", "Lubbock, TX", "Lynchburg, VA", "Lynn, MA", "Lynwood, CA", "Macon, GA", "Madison, AL", "Madison, WI", "Malden, MA",
            "Manchester, NH", "Manhattan, KS", "Mansfield, TX", "Manteca, CA", "Maple Grove, MN", "Margate, FL", "Maricopa, AZ", "Marietta, GA", "Marlborough, MA", "Marysville, WA",
            "McAllen, TX", "McKinney, TX", "Medford, MA", "Medford, OR", "Melbourne, FL", "Memphis, TN", "Menifee, CA", "Merced, CA", "Meridian, ID", "Meridian, MS",
            "Mesquite, TX", "Miami, FL", "Miami Gardens, FL", "Middletown, CT", "Middletown, OH", "Midland, MI", "Midland, TX", "Milford, CT", "Milpitas, CA", "Milwaukee, WI",
            "Minneapolis, MN", "Minnetonka, MN", "Miramar, FL", "Mission, TX", "Mission Viejo, CA", "Missoula, MT", "Missouri City, TX", "Mobile, AL", "Modesto, CA", "Monroe, LA",
            "Montebello, CA", "Montgomery, AL", "Moore, OK", "Moreno Valley, CA", "Morgan Hill, CA", "Mount Pleasant, SC", "Mount Vernon, NY", "Mountain View, CA", "Muncie, IN", "Murfreesboro, TN",
            "Murray, UT", "Murrieta, CA", "Nampa, ID", "Naperville, IL", "Nashua, NH", "Nashville, TN", "New Bedford, MA", "New Braunfels, TX", "New Britain, CT", "New Haven, CT",
            "New Orleans, LA", "New Rochelle, NY", "New York, NY", "Newark, NJ", "Newport Beach, CA", "Newport News, VA", "Newton, MA", "Niagara Falls, NY", "Noblesville, IN", "Norfolk, VA",
            "Normal, IL", "Norman, OK", "North Charleston, SC", "North Las Vegas, NV", "North Little Rock, AR", "North Miami, FL", "North Port, FL", "Norwalk, CA", "Norwalk, CT", "Novato, CA",
            "Oak Lawn, IL", "Oakland, CA", "Ocala, FL", "Oceanside, CA", "Odessa, TX", "O'Fallon, MO", "Ogden, UT", "Oklahoma City, OK", "Olathe, KS", "Olympia, WA",
            "Omaha, NE", "Ontario, CA", "Orange, CA", "Orem, UT", "Orlando, FL", "Ormond Beach, FL", "Orland Park, IL", "Oro Valley, AZ", "Overland Park, KS", "Owensboro, KY",
            "Oxnard, CA", "Palm Bay, FL", "Palm Beach Gardens, FL", "Palm Coast, FL", "Palm Desert, CA", "Palm Springs, CA", "Palmdale, CA", "Palo Alto, CA", "Panama City, FL", "Parker, CO",
            "Parma, OH", "Pasadena, CA", "Pasadena, TX", "Pasco, WA", "Paterson, NJ", "Pawtucket, RI", "Peabody, MA", "Peoria, AZ", "Peoria, IL", "Perris, CA",
            "Petaluma, CA", "Pflugerville, TX", "Pharr, TX", "Philadelphia, PA", "Phoenix, AZ", "Pico Rivera, CA", "Pine Bluff, AR", "Pinellas Park, FL", "Pittsburg, CA", "Pittsburgh, PA",
            "Placentia, CA", "Plainfield, IL", "Plainfield, NJ", "Plantation, FL", "Pleasanton, CA", "Plymouth, MN", "Pocatello, ID", "Pomona, CA", "Pompano Beach, FL", "Port Arthur, TX",
            "Port Orange, FL", "Port St. Lucie, FL", "Portland, ME", "Portland, OR", "Portsmouth, VA", "Pottstown, PA", "Providence, RI", "Provo, UT", "Pueblo, CO", "Quincy, IL",
            "Quincy, MA", "Racine, WI", "Raleigh, NC", "Rancho Cordova, CA", "Rancho Cucamonga, CA", "Rancho Palos Verdes, CA", "Rapid City, SD", "Reading, PA", "Redding, CA", "Redlands, CA",
            "Redmond, WA", "Redondo Beach, CA", "Redwood City, CA", "Reno, NV", "Renton, WA", "Revere, MA", "Richardson, TX", "Richland, WA", "Richmond, CA", "Richmond, VA", "Rio Rancho, NM",
            "Riverton, UT", "Riverside, CA", "Rochester, MN", "Rochester, NY", "Rochester Hills, MI", "Rock Hill, SC", "Rockford, IL", "Rockville, MD", "Rockwall, TX", "Rocky Mount, NC",
            "Rogers, AR", "Rosemead, CA", "Roseville, CA", "Round Rock, TX", "Rowlett, TX", "Royal Oak, MI", "Sacramento, CA", "Salem, OR", "Salinas, CA", "Salt Lake City, UT",
            "Sammamish, WA", "San Angelo, TX", "San Antonio, TX", "San Bernardino, CA", "San Buenaventura (Ventura), CA", "San Clemente, CA", "San Diego, CA", "San Francisco, CA", "San Jacinto, CA", "San Jose, CA",
            "San Leandro, CA", "San Luis Obispo, CA", "San Marcos, CA", "San Mateo, CA", "San Rafael, CA", "Santa Ana, CA", "Santa Barbara, CA", "Santa Clara, CA", "Santa Clarita, CA", "Santa Cruz, CA",
            "Santa Fe, NM", "Santa Maria, CA", "Santa Monica, CA", "Santa Rosa, CA", "Sarasota, FL", "Schaumburg, IL", "Scottsdale, AZ", "Scranton, PA", "Seattle, WA", "Shawnee, KS",
            "Sheboygan, WI", "Shoreline, WA", "Shreveport, LA", "Sierra Vista, AZ", "Silver Spring, MD", "Sioux City, IA", "Sioux Falls, SD", "Skokie, IL", "Smyrna, GA", "Somerville, MA",
            "South Bend, IN", "South Gate, CA", "South Jordan, UT", "Southfield, MI", "Sparks, NV", "Spokane, WA", "Spokane Valley, WA", "Springdale, AR", "Springfield, IL", "Springfield, MA",
            "Springfield, MO", "Springfield, OR", "St. Charles, MO", "St. Cloud, MN", "St. George, UT", "St. Joseph, MO", "St. Louis, MO", "St. Paul, MN", "St. Petersburg, FL", "Stamford, CT",
            "State College, PA", "Sterling Heights, MI", "Stockton, CA", "Streamwood, IL", "Strongsville, OH", "Suffolk, VA", "Sugar Land, TX", "Summerville, SC", "Sunnyvale, CA", "Surprise, AZ",
            "Syracuse, NY", "Tacoma, WA", "Tallahassee, FL", "Tamarac, FL", "Tamiami, FL", "Tampa, FL", "Taunton, MA", "Taylor, MI", "Temecula, CA", "Tempe, AZ",
            "Temple, TX", "Terre Haute, IN", "Texarkana, TX", "Texas City, TX", "The Colony, TX", "Thornton, CO", "Thousand Oaks, CA", "Tigard, OR", "Tinley Park, IL", "Titusville, FL",
            "Toledo, OH", "Torrance, CA", "Tracy, CA", "Trenton, NJ", "Troy, MI", "Troy, NY", "Tucson, AZ", "Tulsa, OK", "Tuscaloosa, AL", "Tustin, CA",
            "Tyler, TX", "Union City, CA", "Union City, NJ", "Upland, CA", "Urbana, IL", "Urbandale, IA", "Vacaville, CA", "Vallejo, CA", "Valparaiso, IN", "Victorville, CA",
            "Vineland, NJ", "Virginia Beach, VA", "Visalia, CA", "Vista, CA", "Waco, TX", "Waipahu, HI", "Waldorf, MD", "Walnut Creek, CA", "Waltham, MA", "Warner Robins, GA",
            "Warren, MI", "Warwick, RI", "Washington DC", "Waterbury, CT", "Waterloo, IA", "Waukegan, IL", "Wausau, WI", "Wauwatosa, WI", "Wellington, FL", "Wesley Chapel, FL",
            "West Allis, WI", "West Covina, CA", "West Des Moines, IA", "West Hartford, CT", "West Haven, CT", "West Jordan, UT", "West New York, NJ", "West Palm Beach, FL", "West Valley City, UT", "Westland, MI",
            "Westminster, CA", "Westminster, CO", "Weston, FL", "Weymouth Town, MA", "Wheaton, IL", "White Plains, NY", "Whittier, CA", "Wichita, KS", "Wichita Falls, TX", "Wilmington, DE",
            "Wilmington, NC", "Wilson, NC", "Winston-Salem, NC", "Winter Garden, FL", "Woodbury, MN", "Woodland, CA", "Worcester, MA", "Wylie, TX", "Wyoming, MI", "Yakima, WA",
            "Yonkers, NY", "Yorba Linda, CA", "Youngstown, OH", "Yuba City, CA", "Yucaipa, CA", "Yuma, AZ"
        ].sort();

        const firebaseConfig = {
            apiKey: "AIzaSyAHZ5v86FWK9uU-9LfZKaBsMR6QQ92JqQM",
            authDomain: "truewebx-78890.firebaseapp.com",
            projectId: "truewebx-78890",
            storageBucket: "truewebx-78890.firebasestorage.app",
            messagingSenderId: "578628752073",
            appId: "1:578628752073:web:c916cc3f234865a2947318"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const SUPABASE_URL = 'https://vrpyomevjlsacourdmki.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZycHlvbWV2amxzYWNvdXJkbWtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzA4ODUsImV4cCI6MjA4MTc0Njg4NX0.BsugjF75UO4TArkH5CeOIvJnMZAj8g6Ccf6hu1NsrUM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // PAYMENT CONFIG REMOVED
        let currentServiceData = null; // temporary storage for form data

        const list = document.getElementById('list');
        const msg = document.getElementById('msg');
        const welcomeMsg = document.getElementById('welcomeMsg');
        let currentEditId = null;
        let currentSocialLinks = [];
        let isSignupMode = false;
        let isPublishing = false;
        let currentChatServiceId = null;

        // ────────────────────────────────────────────────
        // YOUR ORIGINAL FUNCTIONS – 100% UNCHANGED
        // ────────────────────────────────────────────────

        function setupCitySearch(inputId, listId, hiddenId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(listId);
            const hidden = document.getElementById(hiddenId);

            function showDropdown(filter) {
                dropdown.innerHTML = '';
                let filtered = usCities.filter(city => city.toLowerCase().includes(filter));
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="no-results">No cities found</div>';
                } else {
                    filtered.slice(0, 100).forEach(city => {
                        const div = document.createElement('div');
                        div.textContent = city;
                        div.onclick = () => {
                            input.value = city;
                            hidden.value = city;
                            dropdown.style.display = 'none';
                        };
                        dropdown.appendChild(div);
                    });
                    if (filtered.length > 100) {
                        const more = document.createElement('div');
                        more.className = 'no-results';
                        more.textContent = '...type more to refine';
                        dropdown.appendChild(more);
                    }
                }
                dropdown.style.display = 'block';
            }

            input.addEventListener('focus', () => showDropdown(''));
            input.addEventListener('input', () => showDropdown(input.value.toLowerCase()));
            input.addEventListener('click', () => showDropdown(input.value.toLowerCase()));

            document.addEventListener('click', (e) => {
                if (!input.parentElement.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        setupCitySearch('cityAddInput', 'cityAddList', 'cityAdd');
        setupCitySearch('cityEditInput', 'cityEditList', 'cityEdit');

        document.getElementById('zipAdd').addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5));
        document.getElementById('zipEdit').addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5));

        function previewImage(file, containerId, isProfile = false) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = isProfile ? 'profile-preview' : 'preview-img';
                document.getElementById(containerId).innerHTML = '';
                document.getElementById(containerId).appendChild(img);
            };
            reader.readAsDataURL(file);
        }

        function previewMultipleImages(files, containerId) {
            document.getElementById(containerId).innerHTML = '';
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    document.getElementById(containerId).appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('profile').addEventListener('change', e => e.target.files[0] && previewImage(e.target.files[0], 'profilePreview', true));
        document.getElementById('photos').addEventListener('change', e => e.target.files.length && previewMultipleImages(e.target.files, 'galleryPreview'));
        document.getElementById('edit-profile').addEventListener('change', e => e.target.files[0] ? previewImage(e.target.files[0], 'editProfilePreview', true) : document.getElementById('editProfilePreview').innerHTML = '');
        document.getElementById('edit-photos').addEventListener('change', e => e.target.files.length && previewMultipleImages(e.target.files, 'editGalleryPreview'));

        function toggleAuthMode() {
            isSignupMode = !isSignupMode;
            document.getElementById('formTitle').textContent = isSignupMode ? 'Create Account' : 'Sign In';
            document.getElementById('authButton').textContent = isSignupMode ? 'Sign Up' : 'Sign In';
            document.getElementById('toggleText').textContent = isSignupMode ? 'Already have an account?' : "Don't have an account?";
        }

        document.getElementById('authForm').onsubmit = e => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (isSignupMode) {
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => loadDashboard())
                    .catch(err => document.getElementById('message').innerHTML = `<div class="error">${err.message}</div>`);
            } else {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => loadDashboard())
                    .catch(err => document.getElementById('message').innerHTML = `<div class="error">${err.message}</div>`);
            }
        };

        document.getElementById('googleBtn').onclick = () => {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
                .then(() => loadDashboard());
        };

        function logoutAndGoHome() {
            auth.signOut().then(() => {
                window.location.href = 'https://truewebx.site/';
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) loadDashboard(user);
        });

        async function loadDashboard(user = auth.currentUser) {
            if (!user) return;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            welcomeMsg.textContent = `Hello ${user.displayName || user.email.split('@')[0]}!`;

            const { data: services } = await supabaseClient
                .from('services')
                .select('*')
                .eq('owner_id', user.uid)
                .order('created_at', { ascending: false });

            list.innerHTML = services && services.length > 0
                ? services.map(s => `
            <div class="card">
                <div class="edit" onclick="editService('${s.id}')"><i class="fas fa-edit"></i></div>
                <div class="delete" onclick="deleteService('${s.id}')">×</div>
                
                <img src="${s.profile || 'https://via.placeholder.com/600x400/0d9488/ffffff?text=Upload+Your+Logo'}" class="profile-img" alt="Profile">
                
                <h3>${s.name || 'No business name'}</h3>
                <p><strong>${s.city || 'No location'}</strong></p>
                <p>${s.description || 'No description'}</p>
                
                ${Array.isArray(s.photos) && s.photos.length > 0 ? `
                <div class="photos">
                    ${s.photos.map(p => `<img src="${p}" alt="Gallery photo">`).join('')}
                </div>` : ''}
                
                <p>Phone: <span class="private">${s.phone || 'Not available'}</span></p>
                <p>Email: <span class="private">${s.gmail || 'Not available'}</span></p>

                ${Array.isArray(s.social_links) && s.social_links.length > 0 ? `
                <div class="links">
                    ${s.social_links.map(link => `
                        <a href="${link.url}" target="_blank">
                            <i class="fab fa-${link.type.toLowerCase()}"></i> ${link.type}
                        </a>
                    `).join('')}
                </div>` : ''}
            </div>
        `).join('')
                : '<p style="text-align:center; padding:40px; opacity:0.9;">You have no published services yet. Create a new one!</p>';
        }

        function show(section) {
            ['home', 'add', 'edit', 'messages'].forEach(s => document.getElementById(s).style.display = s === section ? 'block' : 'none');
            document.querySelectorAll('.nav-item').forEach((el, i) => el.classList.toggle('active', i === (section === 'home' ? 0 : section === 'add' ? 1 : section === 'messages' ? 2 : 3)));
            if (section === 'home') loadDashboard();
            if (section === 'add') {
                currentSocialLinks = [];
                document.getElementById('added-socials').innerHTML = '';
                document.getElementById('publishBtn').disabled = false;
                document.getElementById('addForm').reset();
                document.getElementById('profilePreview').innerHTML = '';
                document.getElementById('galleryPreview').innerHTML = '';
                document.getElementById('cityAddInput').value = '';
                document.getElementById('cityAdd').value = '';
            }
            if (section === 'messages') loadInbox();
        }

        function addSocialLink(isEdit = false) {
            const select = isEdit ? document.getElementById('edit-social-type') : document.getElementById('social-type');
            const input = isEdit ? document.getElementById('edit-social-url') : document.getElementById('social-url');
            const type = select.value;
            const url = input.value.trim();
            if (url && url.startsWith('http')) {
                currentSocialLinks.push({ type, url });
                updateAddedSocials(isEdit);
                input.value = '';
            } else if (url) {
                alert('Please enter a valid URL (starting with https://)');
            }
        }

        function updateAddedSocials(isEdit = false) {
            const container = isEdit ? 'edit-added-socials' : 'added-socials';
            document.getElementById(container).innerHTML = currentSocialLinks.map((link, i) => `
        <div class="added-link">
            <i class="fab fa-${link.type.toLowerCase()}"></i>
            <span>${link.type}: ${link.url}</span>
            <button onclick="removeSocialLink(${i}, ${isEdit})">×</button>
        </div>
    `).join('');
        }

        function removeSocialLink(index, isEdit = false) {
            currentSocialLinks.splice(index, 1);
            updateAddedSocials(isEdit);
        }

        // ────────────────────────────────────────────────
        // NEW PAYMENT FLOW – EXACTLY AFTER FILLING FORM
        // ────────────────────────────────────────────────

        document.getElementById('publishBtn').onclick = async () => {
            msg.innerHTML = '';
            const btn = document.getElementById('publishBtn');

            // 1. Get values
            const name = document.getElementById('name').value.trim();
            const cityInput = document.getElementById('cityAddInput').value.trim();
            let city = document.getElementById('cityAdd').value;
            const zip = document.getElementById('zipAdd').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const gmail = document.getElementById('gmail').value.trim();
            const desc = document.getElementById('desc').value.trim();
            const profileFile = document.getElementById('profile').files[0];
            const photoFiles = document.getElementById('photos').files;

            // 2. City Fallback: If hidden field is empty but input has a value, try to use it
            if (!city && cityInput) {
                const found = usCities.find(c => c.toLowerCase() === cityInput.toLowerCase());
                if (found) city = found;
                else if (cityInput.includes(',')) city = cityInput; // Accept "City, ST" format directly
            }

            // 3. Granular Validation
            const missing = [];
            if (!name) missing.push("Business Name");
            if (!city) missing.push("City/Location (please select from the list)");
            if (!phone) missing.push("Phone Number");
            if (!gmail) missing.push("Email");
            if (!desc) missing.push("Description");
            if (!profileFile) missing.push("Profile Photo / Logo");

            if (missing.length > 0) {
                msg.innerHTML = `<p style="color:red; background:rgba(255,0,0,0.1); padding:10px; border-radius:8px;">
                    <strong>Required fields are missing:</strong><br>
                    • ${missing.join('<br>• ')}
                </p>`;
                msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            if (zip && zip.length !== 5) {
                msg.innerHTML = '<p style="color:red;">ZIP code must be exactly 5 digits</p>';
                return;
            }

            const baseSlug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const citySlug = city.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const slug = `${baseSlug}-${citySlug}`.slice(0, 100);

            // Store form data temporarily
            currentServiceData = {
                name, city, zip, phone, gmail, desc, profileFile, photoFiles, slug,
                socialLinks: currentSocialLinks.slice()
            };

            // Publish immediately
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PUBLISHING...';
                msg.innerHTML = '<p style="color:#0f0;">Processing... Publishing your service now.</p>';

                await publishServiceAfterPayment();

                msg.innerHTML = `<p style="color:#0f0; font-size:1.2rem; font-weight:bold;">
                    🎉 Published successfully!<br>
                    <span style="font-size:0.9rem; font-weight:normal;">Your public page: <strong>https://truewebx.site/profile/${currentServiceData ? currentServiceData.slug : ''}/</strong></span>
                </p>`;
                setTimeout(() => { show('home'); msg.innerHTML = ''; }, 6000);
            } catch (err) {
                msg.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'PUBLISH NOW';
            }
        };


        async function publishServiceAfterPayment() {
            if (!currentServiceData) return;

            const { name, city, zip, phone, gmail, desc, profileFile, photoFiles, socialLinks, slug } = currentServiceData;

            let location = city;
            if (zip) location += ` ${zip}`;

            const user = auth.currentUser;
            if (!user) return;

            try {
                const fileExt = profileFile.name.split('.').pop();
                const fileName = `profile_${crypto.randomUUID()}.${fileExt}`;
                const { error: profileError } = await supabaseClient.storage.from('profiles').upload(fileName, profileFile);
                if (profileError) throw profileError;
                const { data: profileData } = supabaseClient.storage.from('profiles').getPublicUrl(fileName);
                const profileUrl = profileData.publicUrl;

                const photosUrls = [];
                for (let file of photoFiles) {
                    if (file) {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `photo_${crypto.randomUUID()}.${fileExt}`;
                        const { error } = await supabaseClient.storage.from('photos').upload(fileName, file);
                        if (error) continue;
                        const { data } = supabaseClient.storage.from('photos').getPublicUrl(fileName);
                        photosUrls.push(data.publicUrl);
                    }
                }

                const service = {
                    id: crypto.randomUUID(),
                    owner_id: user.uid,
                    name,
                    city: location,
                    phone,
                    gmail,
                    description: desc,
                    profile: profileUrl,
                    photos: photosUrls,
                    social_links: socialLinks,
                    slug,
                    created_at: new Date().toISOString()
                };

                const { error } = await supabaseClient.from('services').insert(service);
                if (error) throw error;

                // Reset form
                document.getElementById('addForm').reset();
                currentSocialLinks = [];
                document.getElementById('added-socials').innerHTML = '';
                document.getElementById('profilePreview').innerHTML = '';
                document.getElementById('galleryPreview').innerHTML = '';
                document.getElementById('cityAddInput').value = '';
                document.getElementById('cityAdd').value = '';
                currentServiceData = null;

            } catch (err) {
                console.error(err);
                msg.innerHTML = `<p style="color:red;">Error publishing: ${err.message}</p>`;
            }
        }


        // ────────────────────────────────────────────────
        // REST OF YOUR ORIGINAL SCRIPT (unchanged)
        // ────────────────────────────────────────────────

        async function editService(id) {
            currentEditId = id;
            const { data: service } = await supabaseClient.from('services').select('*').eq('id', id).single();

            document.getElementById('edit-name').value = service.name || '';
            document.getElementById('edit-phone').value = service.phone || '';
            document.getElementById('edit-gmail').value = service.gmail || '';
            document.getElementById('edit-desc').value = service.description || '';

            const locationParts = service.city ? service.city.trim().split(' ') : [];
            const zipPart = locationParts.length > 1 && /^\d{5}$/.test(locationParts[locationParts.length - 1]) ? locationParts.pop() : '';
            const cityWithState = locationParts.join(' ');

            document.getElementById('cityEditInput').value = cityWithState;
            document.getElementById('cityEdit').value = cityWithState;
            document.getElementById('zipEdit').value = zipPart;

            currentSocialLinks = Array.isArray(service.social_links) ? service.social_links : [];
            updateAddedSocials(true);
            document.getElementById('editProfilePreview').innerHTML = '';
            document.getElementById('editGalleryPreview').innerHTML = '';

            show('edit');
        }

        async function updateService() {
            if (!currentEditId) return;

            const name = document.getElementById('edit-name').value.trim();
            const city = document.getElementById('cityEdit').value;
            const zip = document.getElementById('zipEdit').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const gmail = document.getElementById('edit-gmail').value.trim();
            const desc = document.getElementById('edit-desc').value.trim();

            if (!name || !city || !phone || !gmail || !desc) {
                document.getElementById('edit-msg').innerHTML = '<p style="color:red;">Required fields cannot be empty</p>';
                return;
            }

            if (zip && zip.length !== 5) {
                document.getElementById('edit-msg').innerHTML = '<p style="color:red;">ZIP code must be exactly 5 digits</p>';
                return;
            }

            let location = city;
            if (zip) location += ` ${zip}`;

            const baseSlug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const citySlug = city.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const slug = `${baseSlug}-${citySlug}`.slice(0, 100);

            try {
                const profileFile = document.getElementById('edit-profile').files[0];
                const { data: current } = await supabaseClient.from('services').select('profile, photos').eq('id', currentEditId).single();

                let profileUrl = current.profile;
                if (profileFile) {
                    const fileExt = profileFile.name.split('.').pop();
                    const fileName = `profile_${crypto.randomUUID()}.${fileExt}`;
                    const { error } = await supabaseClient.storage.from('profiles').upload(fileName, profileFile);
                    if (error) throw error;
                    const { data } = supabaseClient.storage.from('profiles').getPublicUrl(fileName);
                    profileUrl = data.publicUrl;
                }

                let photosUrls = current.photos || [];
                const photoFiles = document.getElementById('edit-photos').files;
                for (let file of photoFiles) {
                    if (file) {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `photo_${crypto.randomUUID()}.${fileExt}`;
                        const { error } = await supabaseClient.storage.from('photos').upload(fileName, file);
                        if (error) throw error;
                        const { data } = supabaseClient.storage.from('photos').getPublicUrl(fileName);
                        photosUrls.push(data.publicUrl);
                    }
                }

                const updates = {
                    name,
                    city: location,
                    phone,
                    gmail,
                    description: desc,
                    profile: profileUrl,
                    photos: photosUrls,
                    social_links: currentSocialLinks,
                    slug
                };

                const { error } = await supabaseClient.from('services').update(updates).eq('id', currentEditId);
                if (error) throw error;

                document.getElementById('edit-msg').innerHTML = '<p style="color:#0f0;">Updated successfully! New URL: https://truewebx.site/#' + slug + '</p>';
                setTimeout(() => { show('home'); document.getElementById('edit-msg').innerHTML = ''; }, 4000);
            } catch (err) {
                document.getElementById('edit-msg').innerHTML = `<p style="color:red;">Error: ${err.message || 'Unknown error'}</p>`;
            }
        }

        async function deleteService(id) {
            if (confirm('Are you sure you want to delete this service?')) {
                const { error } = await supabaseClient.from('services').delete().eq('id', id);
                if (error) alert('Error: ' + error.message);
                loadDashboard();
            }
        }

        let currentChatCustomerId = null;

        async function loadInbox() {
            const user = auth.currentUser;
            if (!user) return;

            const { data: services } = await supabaseClient.from('services').select('id, name').eq('owner_id', user.uid);
            if (!services || services.length === 0) {
                document.getElementById('inboxList').innerHTML = '<p style="text-align:center;">No services yet</p>';
                return;
            }

            const { data: messages } = await supabaseClient.from('messages')
                .select('service_id, customer_id, text, created_at, is_from_owner')
                .in('service_id', services.map(s => s.id))
                .order('created_at', { ascending: false });

            const chats = {};
            messages.forEach(m => {
                if (m.text.startsWith('[User:')) {
                    customerKey = m.text.split(']')[0] + ']';
                    displayName = `User ${customerKey.slice(7, 12)}...`;
                } else if (m.text.startsWith('[GuestID:')) {
                    customerKey = m.text.split(']')[0] + ']';
                    // Extract name if available, otherwise "Guest"
                    displayName = m.text.includes('[Guest: ') ? m.text.split('[Guest: ')[1].split('|')[0].trim() : 'Guest Inquiry';
                } else if (m.text.startsWith('[Guest:')) {
                    customerKey = m.text.split(']')[0] + ']';
                    displayName = m.text.split('|')[0].replace('[Guest: ', '').trim();
                } else {
                    customerKey = 'Legacy_Guest';
                }

                const chatKey = `${m.service_id}_${customerKey}`;

                if (!chats[chatKey]) {
                    const serviceName = services.find(s => s.id === m.service_id)?.name || 'Unknown';

                    chats[chatKey] = {
                        serviceId: m.service_id,
                        customerId: m.customer_id,
                        customerKey: customerKey,
                        serviceName: serviceName,
                        displayName: displayName,
                        lastMessage: m.text.includes('] - ') ? m.text.split('] - ').slice(1).join('] - ') : m.text,
                        time: m.created_at,
                        unread: !m.is_from_owner
                    };
                }
            });

            document.getElementById('inboxList').innerHTML = Object.keys(chats).length ?
                Object.values(chats).map(chat => `
            <div class="inbox-item ${chat.unread ? 'unread' : ''}" onclick="openChat('${chat.serviceId}', '${chat.customerKey}', '${chat.displayName.replace(/'/g, "\\'")}', '${chat.serviceName.replace(/'/g, "\\'")}')">
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <strong>${chat.displayName}</strong>
                    <small style="opacity:0.6;">@ ${chat.serviceName}</small>
                </div>
                <div style="opacity:0.9;font-size:0.95rem;margin-top:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${chat.lastMessage}</div>
                <small>${new Date(chat.time).toLocaleString()}</small>
            </div>
        `).join('') : '<p style="text-align:center; opacity:0.8;">No messages yet</p>';
        }

        let currentChatCustomerKey = null;

        async function openChat(serviceId, customerKey, customerName, serviceName) {
            currentChatServiceId = serviceId;
            currentChatCustomerKey = customerKey;
            document.getElementById('chatHeader').textContent = `Chat: ${customerName} (${serviceName})`;
            document.getElementById('chatWindow').style.display = 'flex';
            loadChatMessages();
        }

        async function loadChatMessages() {
            const { data } = await supabaseClient.from('messages')
                .select('*')
                .eq('service_id', currentChatServiceId)
                .ilike('text', `${currentChatCustomerKey}%`)
                .order('created_at', { ascending: true });

            const body = document.getElementById('chatBody');
            body.innerHTML = data.map(m => {
                // Strips [User: ID], [GuestID: ID], and [Guest: Name | Contact] prefixes
                let cleanText = m.text;
                if (cleanText.includes('] - ')) {
                    const parts = cleanText.split('] - ');
                    cleanText = parts[parts.length - 1]; // Get the last part (the actual message)
                }
                // Also remove owner internal marker if present
                cleanText = cleanText.replace('[Owner]: ', '');

                return `
                <div class="message ${m.is_from_owner ? 'owner' : 'client'}">
                    ${cleanText}
                    <small>${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                </div>
            `;
            }).join('');
            body.scrollTop = body.scrollHeight;
        }

        async function sendReply() {
            const input = document.getElementById('replyInput');
            const text = input.value.trim();
            if (!text || !currentChatServiceId) return;

            // Maintain the internal identity prefix for thread consistency
            const prefixedText = `${currentChatCustomerKey} - [Owner]: ${text}`;

            await supabaseClient.from('messages').insert({
                service_id: currentChatServiceId,
                customer_id: null,
                text: prefixedText,
                is_from_owner: true
            });

            input.value = '';
            loadChatMessages();
        }

        document.getElementById('replyInput')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendReply();
        });
    </script>
</body>

</html>